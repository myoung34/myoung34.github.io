<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Marcus Young]]></title>
  <link href="http://marcyoung.us/atom.xml" rel="self"/>
  <link href="http://marcyoung.us/"/>
  <updated>2017-12-23T13:55:58-06:00</updated>
  <id>http://marcyoung.us/</id>
  <author>
    <name><![CDATA[Marcus Young]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Vault as a CA for ECS containers using Terraform (Part 2)]]></title>
    <link href="http://marcyoung.us/post/docker-vault-ca-part2"/>
    <updated>2017-12-24T00:00:00-06:00</updated>
    <id>http://marcyoung.us/post/docker-vault-ca-part2</id>
    <content type="html"><![CDATA[<p>Now for some cool snippets on how to automatically request certs from the Intermediary we created in Part 1<!-- more --></p>

<h2>Dockerfile</h2>

<p>An example of how I typically get Vault into my base Container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FROM debian:jessie
</span><span class='line'>ENV VAULT_VERSION 0.8.1
</span><span class='line'>ENV DUMBINIT_VERSION 1.2.0
</span><span class='line'>
</span><span class='line'>RUN apt-get update && apt-get install -y \
</span><span class='line'>      apt-transport-https \
</span><span class='line'>      ca-certificates \
</span><span class='line'>      wget \
</span><span class='line'>      unzip \
</span><span class='line'>      jq \
</span><span class='line'>      curl \
</span><span class='line'>    nginx \
</span><span class='line'>  --no-install-recommends && rm -rf /var/lib/apt/lists/*
</span><span class='line'>
</span><span class='line'>RUN curl -L --silent -o vault.zip https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip && \
</span><span class='line'>  unzip vault.zip && \
</span><span class='line'>  mv vault /usr/local/bin/vault && \
</span><span class='line'>  chmod +x /usr/local/bin/vault
</span><span class='line'>
</span><span class='line'>RUN curl -L --silent -o /usr/local/bin/dumb-init https://github.com/Yelp/dumb-init/releases/download/v${DUMBINIT_VERSION}/dumb-init_${DUMBINIT_VERSION}_amd64 && \
</span><span class='line'>  chmod +x /usr/local/bin/dumb-init
</span><span class='line'>
</span><span class='line'>RUN mkdir -p /opt/ssl
</span><span class='line'>COPY docker-entrypoint.sh /
</span><span class='line'>RUN chmod +x /docker-entrypoint.sh
</span><span class='line'>ENTRYPOINT ["/usr/local/bin/dumb-init", "--"]
</span><span class='line'>CMD ["/docker-entrypoint.sh"]</span></code></pre></td></tr></table></div></figure>


<h2>The Entrypoint</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>export SSL_PATH=/opt/ssl
</span><span class='line'>
</span><span class='line'>EC2_AVAIL_ZONE=$(curl -s --max-time 5 http://169.254.169.254/latest/meta-data/placement/availability-zone)
</span><span class='line'>if [[ $? -eq 0 ]]; then
</span><span class='line'>  # shellcheck disable=SC2001,SC2006
</span><span class='line'>  EC2_REGION="`echo \"$EC2_AVAIL_ZONE\" | sed -e 's:\([0-9][0-9]*\)[a-z]*\$:\\1:'`"
</span><span class='line'>  export AWS_DEFAULT_REGION=$EC2_REGION
</span><span class='line'>  export AWS_REGION=$EC2_REGION
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>[[ -z "${VAULT_TOKEN}" ]] && vault auth -method=aws &gt;/dev/null
</span><span class='line'>
</span><span class='line'>VAULT_JSON="$(vault write -format=json cuddletech_ops/issue/jenkins common_name=jenkins ttl=15551999)"
</span><span class='line'>
</span><span class='line'>echo "$VAULT_JSON" | jq -r .data.private_key &gt; ${SSL_PATH}/key.pem
</span><span class='line'>echo "$VAULT_JSON" | jq -r .data.certificate &gt; ${SSL_PATH}/cert.pem
</span><span class='line'>echo "$VAULT_JSON" | jq -r .data.issuing_ca  &gt; ${SSL_PATH}/ca.pem
</span><span class='line'>cat ${SSL_PATH}/cert.pem ${SSL_PATH}/ca.pem  &gt; ${SSL_PATH}/bundle.pem
</span><span class='line'>
</span><span class='line'># run your command and point to the certs generated above. Example in nginx:
</span><span class='line'>#        ssl                  on;
</span><span class='line'>#        ssl_certificate      /opt/ssl/bundle.pem;
</span><span class='line'>#        ssl_certificate_key  /opt/ssl/key.pem;</span></code></pre></td></tr></table></div></figure>


<h2>Terraforming the certificate issuer</h2>

<p>If you somehow get the previous part to run, it will fail because you have to create the role in Vault before you can just start generating certs off it. In the <a href="http://cuddletech.com/?p=959">cuddletech guide</a> this is under <code>Requesting a Certificate for a Web Server</code> as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vault write cuddletech_ops/roles/web_server \
</span><span class='line'>&gt; key_bits=2048 \
</span><span class='line'>&gt; max_ttl=8760h \
</span><span class='line'>&gt; allow_any_name=true
</span><span class='line'>Success! Data written to: cuddletech_ops/roles/web_server</span></code></pre></td></tr></table></div></figure>


<p>But what if I told you, you could do that in terraform?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>variable "role" {
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "vault_generic_secret" "pki_role" {
</span><span class='line'>  path = "cuddletech_ops/roles/${var.role}"
</span><span class='line'>
</span><span class='line'>  data_json = &lt;&lt;EOT
</span><span class='line'>{
</span><span class='line'>  "key_bits": "2048",
</span><span class='line'>  "max_ttl": "8760h",
</span><span class='line'>  "allow_any_name": "true"
</span><span class='line'>}
</span><span class='line'>EOT
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>If you add that with your ECS task along with the vault role and policy from the previous post about Vault Anything in Terraform, all your dependencies are met and kept in code!</p>

<p>You can now generate certificates off your PKI backend and grab secrets all in one go!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Vault as a CA for ECS containers using Terraform (Part 1)]]></title>
    <link href="http://marcyoung.us/post/docker-vault-ca-part1"/>
    <updated>2017-12-24T00:00:00-06:00</updated>
    <id>http://marcyoung.us/post/docker-vault-ca-part1</id>
    <content type="html"><![CDATA[<p>In this I&rsquo;ll show some examples on how to leverage HashiCorp Vault as an awesome CA. Note this part is boring and 80% copy/paste from a cuddletech blog. <!-- more --></p>

<h2>Prerequisites</h2>

<ol>
<li>Vault running as a server</li>
<li>Vault CLI to match the server</li>
</ol>


<h2>Create the Root cert/key</h2>

<p>(This is actually mostly a clone from <a href="http://cuddletech.com/?p=959">here</a> but I want to make sure it never disappears)</p>

<p><em>Note</em>: You should not let the vault server generate the root CA, you should generate it and import it. I just havent figured out how to do that yet. I will update this post when I get around to it. <a href="https://en.wikipedia.org/wiki/Offline_root_certificate_authority">More info on that here</a></p>

<ol>
<li>Mount the PKI backend for the root</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vault mount -path=cuddletech -description="Cuddletech Root CA" -max-lease-ttl=87600h pki
</span><span class='line'>Successfully mounted 'pki' at 'cuddletech'!
</span><span class='line'>$ vault mounts
</span><span class='line'>Path         Type       Default TTL  Max TTL    Description
</span><span class='line'>cubbyhole/   cubbyhole  n/a          n/a        per-token private secret storage
</span><span class='line'>cuddletech/  pki        system       315360000  Cuddletech Root CA
</span><span class='line'>secret/      generic    system       system     generic secret storage
</span><span class='line'>sys/         system     n/a          n/a        system endpoints used for control, policy and debugging </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vault write cuddletech/root/generate/internal \
</span><span class='line'>&gt; common_name="Cuddletech Root CA" \
</span><span class='line'>&gt; ttl=87600h \
</span><span class='line'>&gt; key_bits=4096 \
</span><span class='line'>&gt; exclude_cn_from_sans=true
</span><span class='line'>Key             Value
</span><span class='line'>---             -----
</span><span class='line'>certificate     -----BEGIN CERTIFICATE-----
</span><span class='line'>MIIFKzCCAxOgAwIBAgIUDXiI3GDzP2IbQ9IatFSCv9Pq/lgwDQYJKoZIhvcNAQEL
</span><span class='line'>BQAwHTEbMBkGA1UEAxMSQ3VkZGxldGVjaCBSb290IENBMB4XDTE2MDcwOTA4MTIz
</span><span class='line'>..
</span><span class='line'>axscmLdVE2HTB87W1H77iKKN8n9Xne//LUidxVX0Kg==
</span><span class='line'>-----END CERTIFICATE-----
</span><span class='line'>expiration      1783411981
</span><span class='line'>issuing_ca      -----BEGIN CERTIFICATE-----
</span><span class='line'>MIIFKzCCAxOgAwIBAgIUDXiI3GDzP2IbQ9IatFSCv9Pq/lgwDQYJKoZIhvcNAQEL
</span><span class='line'>BQAwHTEbMBkGA1UEAxMSQ3VkZGxldGVjaCBSb290IENBMB4XDTE2MDcwOTA4MTIz
</span><span class='line'>...
</span><span class='line'>axscmLdVE2HTB87W1H77iKKN8n9Xne//LUidxVX0Kg==
</span><span class='line'>-----END CERTIFICATE-----
</span><span class='line'>serial_number   0d:78:88:dc:60:f3:3f:62:1b:43:d2:1a:b4:54:82:bf:d3:ea:fe:58</span></code></pre></td></tr></table></div></figure>


<p>Verify</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s http://localhost:8200/v1/cuddletech/ca/pem | openssl x509 -text
</span><span class='line'>Certificate:
</span><span class='line'>    Data:
</span><span class='line'>        Version: 3 (0x2)
</span><span class='line'>        Serial Number:
</span><span class='line'>            0d:78:88:dc:60:f3:3f:62:1b:43:d2:1a:b4:54:82:bf:d3:ea:fe:58
</span><span class='line'>    Signature Algorithm: sha256WithRSAEncryption
</span><span class='line'>        Issuer: CN=Cuddletech Root CA
</span><span class='line'>        Validity
</span><span class='line'>            Not Before: Jul  9 08:12:31 2016 GMT
</span><span class='line'>            Not After : Jul  7 08:13:01 2026 GMT
</span><span class='line'>        Subject: CN=Cuddletech Root CA
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Fix the URL for accessing the CA/CRL URLs</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vault write cuddletech/config/urls issuing_certificates="http://10.0.0.22:8200/v1/cuddletech
</span><span class='line'>Success! Data written to: cuddletech/config/urls</span></code></pre></td></tr></table></div></figure>


<h2>Create the Intermediate cert/key</h2>

<p>Mount the PKI for the Intermediate (similar to root)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vault mount -path=cuddletech_ops -description="Cuddletech Ops Intermediate CA" -max-lease-ttl=26280h pki
</span><span class='line'>Successfully mounted 'pki' at 'cuddletech_ops'!
</span><span class='line'>
</span><span class='line'>$ vault mounts
</span><span class='line'>Path             Type       Default TTL  Max TTL    Description
</span><span class='line'>cubbyhole/       cubbyhole  n/a          n/a        per-token private secret storage
</span><span class='line'>cuddletech/      pki        system       315360000  Cuddletech Root CA
</span><span class='line'>cuddletech_ops/  pki        system       94608000   Cuddletech Ops Intermediate CA</span></code></pre></td></tr></table></div></figure>


<p>Generate the intermediate CSR</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vault write cuddletech_ops/intermediate/generate/internal \
</span><span class='line'>&gt;  common_name="Cuddletech Operations Intermediate CA"
</span><span class='line'>&gt;  ttl=26280h \
</span><span class='line'>&gt;  key_bits=4096 \
</span><span class='line'>&gt;  exclude_cn_from_sans=true
</span><span class='line'>Key     Value
</span><span class='line'>---     -----
</span><span class='line'>csr     -----BEGIN CERTIFICATE REQUEST-----
</span><span class='line'>MIICuDCCAaACAQAwMDEuMCwGA1UEAxMlQ3VkZGxldGVjaCBPcGVyYXRpb25zIElu
</span><span class='line'>dGVybWVkaWF0ZSBDQTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALt8
</span><span class='line'>...
</span><span class='line'>hD8cpHTXqjKExYWKc/rQDgjw9+RNDdb45xszDagrgFgNPqI9i0fNh9jViMmjUiTc
</span><span class='line'>PQTZS4XxIoRrx1/xVHJ4Qm++ntLPVCvzjMZafg==
</span><span class='line'>-----END CERTIFICATE REQUEST-----</span></code></pre></td></tr></table></div></figure>


<p>Cut and paste that CSR into a new file cuddletech_ops.csr. The reason we output the file here is so we can get it out of one backend and into another and then back out.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vault write cuddletech/root/sign-intermediate \
</span><span class='line'>&gt;  csr=@cuddletech_ops.csr \
</span><span class='line'>&gt;  common_name="Cuddletech Ops Intermediate CA" \
</span><span class='line'>&gt;  ttl=8760h
</span><span class='line'>Key             Value
</span><span class='line'>---             -----
</span><span class='line'>certificate     -----BEGIN CERTIFICATE-----
</span><span class='line'>MIIEZDCCAkygAwIBAgIUHuIhRF3tYtfoZiAFdjcCtQpMR+cwDQYJKoZIhvcNAQEL
</span><span class='line'>BQAwHTEbMBkGA1UEAxMSQ3VkZGxldGVjaCBSb290IENBMB4XDTE2MDcwOTA4Mjkz
</span><span class='line'>...
</span><span class='line'>UtI2b/AamAqf340eRKmSdEh4WypB4JR+t259YA45w2j4mS+rxREycEk4YosR/vUs
</span><span class='line'>jekMiq57yNq7h8eOTrnOulJxazbVrYGb
</span><span class='line'>-----END CERTIFICATE-----
</span><span class='line'>expiration      1470645002
</span><span class='line'>issuing_ca      -----BEGIN CERTIFICATE-----
</span><span class='line'>MIIFKzCCAxOgAwIBAgIUDXiI3GDzP2IbQ9IatFSCv9Pq/lgwDQYJKoZIhvcNAQEL
</span><span class='line'>BQAwHTEbMBkGA1UEAxMSQ3VkZGxldGVjaCBSb290IENBMB4XDTE2MDcwOTA4MTIz
</span><span class='line'>..
</span><span class='line'>1FRGlwHUg+6IIZBVIapzivLc6pAvLFPxQlQvT5CNHPk91zwyNQ9ZX2PzatdajUnd
</span><span class='line'>axscmLdVE2HTB87W1H77iKKN8n9Xne//LUidxVX0Kg==
</span><span class='line'>-----END CERTIFICATE-----
</span><span class='line'>serial_number   1e:e2:21:44:5d:ed:62:d7:e8:66:20:05:76:37:02:b5:0a:4c:47:e7</span></code></pre></td></tr></table></div></figure>


<p>Now that we have a Root CA signed cert, we’ll need to cut-n-paste this certificate into a file we’ll name cuddletech_ops.crt and then import it into our Intermediate CA backend:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vault write cuddletech_ops/intermediate/set-signed \
</span><span class='line'>&gt; certificate=@cuddletech_ops.crt
</span><span class='line'>Success! Data written to: cuddletech_ops/intermediate/set-signed</span></code></pre></td></tr></table></div></figure>


<p>Awesome! Lets verify:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s http://localhost:8200/v1/cuddletech_ops/ca/pem | openssl x509 -text | head -20
</span><span class='line'>Certificate:
</span><span class='line'>    Data:
</span><span class='line'>        Version: 3 (0x2)
</span><span class='line'>        Serial Number:
</span><span class='line'>            76:12:53:41:be:18:98:2c:a1:51:4a:f8:f0:bd:b4:a3:44:7e:74:59
</span><span class='line'>    Signature Algorithm: sha256WithRSAEncryption
</span><span class='line'>        Issuer: CN=Cuddletech Root CA
</span><span class='line'>        Validity
</span><span class='line'>            Not Before: Jul  9 09:23:39 2016 GMT
</span><span class='line'>            Not After : Jul  9 09:24:09 2017 GMT
</span><span class='line'>        Subject: CN=Cuddletech Ops Intermediate CA
</span><span class='line'> ...</span></code></pre></td></tr></table></div></figure>


<p>The last thing we need to do is set the CA &amp; CRL URL’s for accessing the CA:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vault write cuddletech_ops/config/urls \
</span><span class='line'>&gt; issuing_certificates="http://10.0.0.22:8200/v1/cuddletech_ops/ca" \
</span><span class='line'>&gt; crl_distribution_points="http://10.0.0.22:8200/v1/cuddletech_ops/crl"
</span><span class='line'>Success! Data written to: cuddletech_ops/config/urls</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Vault Roles/Policies in Terraform]]></title>
    <link href="http://marcyoung.us/post/vault-anything-in-terraform"/>
    <updated>2017-12-23T00:00:00-06:00</updated>
    <id>http://marcyoung.us/post/vault-anything-in-terraform</id>
    <content type="html"><![CDATA[<p>Now we get to the fun part and put everything we need from Vault in terraform. <!-- more --></p>

<p>If you&rsquo;ve used ECS and Vault with the <a href="https://www.vaultproject.io/docs/auth/aws.html">aws auth backend</a> you may have found a bit of a snag in terms of automation.</p>

<p>Lets say you want to create a new ECS container to run. You want that task to get specific secrets in vault by role. You write the code, terraform, etc and when it runs you get:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>URL: GET http://server:8200/v1/auth/aws-ec2/role/somerole
</span><span class='line'>Code: 400. Errors:
</span><span class='line'>
</span><span class='line'>* entry for role somerole not found</span></code></pre></td></tr></table></div></figure>


<p>So you deployed something but now you have to create a policy, a role, etc in vault via the CLI, all the while your task is throttling.</p>

<p>Little known fact: the terribly-named <code>vault_generic_secret</code> from the <a href="https://www.terraform.io/docs/providers/vault/index.html">provider docs</a> can do create roles/policies in addition to secrets (hence the bad name).</p>

<p>In this part 2 I&rsquo;ll show you how to automate the next step of your ECS task into terraform so there&rsquo;s no race condition.</p>

<h2>Prerequisites</h2>

<ol>
<li>Vault running as a server</li>
<li>Vault CLI to match the server</li>
<li>Terraform</li>
</ol>


<h2>Create a vault policy in terraform</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "vault_generic_secret" "policy" {
</span><span class='line'>  path = "sys/policy/${aws_iam_role.neutrona_wand.name}"
</span><span class='line'>
</span><span class='line'>  data_json = &lt;&lt;EOT
</span><span class='line'>{
</span><span class='line'>  "name": "${aws_iam_role.neutrona_wand.name}",
</span><span class='line'>  "rules": "path \"secret/ops/*\" {\n  policy = \"read\"\n}\n\npath \"secret/common/*\" {\n  policy = \"read\"\n}"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>EOT
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Create an AWS auth role in terraform</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>provider "vault" {}
</span><span class='line'>
</span><span class='line'>resource "aws_iam_role" "neutrona_wand" {
</span><span class='line'>  name = "neutrona_wand"
</span><span class='line'>  path = "/lambda/"
</span><span class='line'>
</span><span class='line'>  assume_role_policy = &lt;&lt;POLICY
</span><span class='line'>{
</span><span class='line'>  "Version": "2012-10-17",
</span><span class='line'>  "Statement": [
</span><span class='line'>    {
</span><span class='line'>      "Sid": "",
</span><span class='line'>      "Effect": "Allow",
</span><span class='line'>      "Principal": {
</span><span class='line'>        "Service": [
</span><span class='line'>          "lambda.amazonaws.com"
</span><span class='line'>        ]
</span><span class='line'>      },
</span><span class='line'>      "Action": "sts:AssumeRole"
</span><span class='line'>    }
</span><span class='line'>  ]
</span><span class='line'>}
</span><span class='line'>POLICY
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'># The ugly replace in 'bound_iam_principal_arn' is to account for removing the path from the role. 
</span><span class='line'># If you look, my IAM role is /lambda/, so the arn would be 'arn:aws:iam::1234567890:role/lambda/neutrona_wand'
</span><span class='line'># While the 'bound_iam_principal_arn' wants the non-path version: 'arn:aws:iam::1234567890:role/neutrona_wand'
</span><span class='line'>resource "vault_generic_secret" "role" {
</span><span class='line'>  path = "auth/aws/role/${aws_iam_role.neutrona_wand.name}"
</span><span class='line'>
</span><span class='line'>  data_json = &lt;&lt;EOT
</span><span class='line'>{
</span><span class='line'>  "bound_iam_principal_arn": "${replace(aws_iam_role.neutrona_wand.arn, "/:role\\/[a-zA-Z\\/]*\\//", ":role\\/")}",
</span><span class='line'>  "policies": "default,${aws_iam_role.neutrona_wand.name},slack",
</span><span class='line'>  "max_ttl":"300",
</span><span class='line'>  "resolve_aws_unique_ids": "false"
</span><span class='line'>}
</span><span class='line'>EOT
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[re:Invent 2017 (never again)]]></title>
    <link href="http://marcyoung.us/post/reinvent-2017"/>
    <updated>2017-12-22T00:00:00-06:00</updated>
    <id>http://marcyoung.us/post/reinvent-2017</id>
    <content type="html"><![CDATA[<p>This was my worst overall conference experience to date. <!-- more --></p>

<p>Along with many others, I had my share of complaints, but this one takes the cake.</p>

<p>This conference had an estimated 43,000 people. It was yuge. And it was actually well-run. Everything &ldquo;ran&rdquo; smoothly overall, but the experiences varied wildly from person to person. I&rsquo;ll sum mine up:</p>

<ol>
<li>I registered for talks only 2-3 days after it opened. I was &ldquo;confirmed&rdquo; for 3. All others for 6 days were walk up only.</li>
<li>We were told to get to walk ups at least 30min early. The rooms were guaranteed 80% reserved with 20% for walk ups. I was at multiple over an hour early at 3 and sat outside and worked, no big deal. I was in the 20% buffer each time, confirmed by the person counting the line. At all 3 I was turned away within 15 people of the door for &ldquo;fire code&rdquo;. So the math: An hour sitting, turned away. The next talk is in 30 min, so that&rsquo;s a no go. So waste 30 minutes or and spend an hour waiting at next one to get in. Turned away there as well, with nothing to do for the next 30min. That&rsquo;s 3 hours of sitting.</li>
<li>Each full room has &lsquo;overflow&rsquo;. One was great, it was a big auditorium with bluetooth headsets and limited capacity, which I was able to get into. The others were a big shared room using a special WiFi hotspot to listen in on an app you download to your phone. It was oversaturated by all of the overflow so it kept cutting out. That happened twice.</li>
<li>The main talks were spread across 3-4 hotels, the main ones being MGM Grand and the Venetian, which are not near each other. So you walk or take the provided buses. The buses are great, but they didnt travel the strip and took about 20 minutes to make the 1.5 mile distance. Next: all of the buses load and unload at the same spot. So you end up waiting an extra 15-20min in a busline waiting for the other multiple buses to  unload then fully (or partially) load back. So ~45minutes for a 1.5mile ride.</li>
</ol>


<p>So after 6 days I got to see 3 talks. I asked for a refund and was given the approval, but was told that &ldquo;a few thousand people are having similar complaints. management is already looking at how to improve the 2018 version based on feedback.&rdquo;</p>

<p>Notable annoyances on the trip not related to amazon but added to the overall experience:</p>

<ol>
<li>The MGM grand was full and I obviously got the &lsquo;under construction&rsquo; room. There was no placard (number) so it was hard to find (especially if drinking). The entertainment center was completely busted with wood that fell when I tried to use it. The wall safe was closed/locked and management could not get it to open, so I couldn&rsquo;t use it for my cash. My keycards didnt work, and it&rsquo;s on the other side of the hotel from the lobby (~10min walk). When it&rsquo;s late: walk 10 min to the room. Cards dont work. Walk 10 min to lobby to get new one. Walk 10 min back to get into room. This happened 4 times to the point where they  waived all of my fees and changed the lock on day 4 to an upgraded RFID version (so kudos there).</li>
<li>American airlines keeps changing my name to Marcus AMERICANAIRLINES Young. TSA precheck checks against your full name so I have to get it printed at counter (waiting in that line negates the bonus of having TSA precheck). They couldnt get it to go through even after confirming my KTN and said &ldquo;all they can do is keep printing my ticket to see if it gets TSA&rdquo;. So after spending an hour to not get that to work I just go through the normal line (why did I pay for TSA precheck?)</li>
</ol>


<p>I used up my entire conference budget for re:Invent. Never again.</p>

<p> /rant</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ergonomic Mouse Review]]></title>
    <link href="http://marcyoung.us/post/ergo-mouse-review"/>
    <updated>2017-06-26T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/ergo-mouse-review</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve Recently been really into ergonomic mice, and wanted to give my thoughts on a few after going all in. <!-- more --></p>

<p>In the last few months, I&rsquo;ve been pretty into mechanical keyboards and form factor. I&rsquo;ve been using an original (very old) Rollermouse for about 2 years now and was looking to upgrade it (the thing is huge).</p>

<p>My current home setup is a Contour Rollermouse free2 and a pok3r (Cherry MX Clears) and a Logitech G700s for gaming.
<img class="left" src="http://marcyoung.us/images/free1.jpg"></p>

<p>My work set up is a TechKeys JD40 on a 1up case (80g Cherry MX browns) and a Contour Rollermouse Red.
<img class="left" src="http://marcyoung.us/images/red1.jpg"></p>

<p>While shopping around, I came upon the <a href="http://amzn.to/2tguHYQ">Penclic NiceTouch t2</a>. It caught my eye because it&rsquo;s <em>exactly</em> the same size as my pok3r. The original contourmouse is hilariously larger than my keyboard, so that&rsquo;s a huge draw.
They sent me one to sample, so I decided to do a pro/con of my setups.</p>

<h2>Contourmouse Red</h2>

<p>This is by far the most sturdy of all of the mice. It&rsquo;s made of stainless steel, and could be used as a bludgeon. It doesnt move, and the rollerbar at the top is very thick with a grippy surface area to it.
My biggest complaint with the original contourmouse was that you ran out of horizontal space. You&rsquo;d have to hold it far left to let the mouse slowly track over, or right because there was no physical space for the mouse to go left or right anymore.
I got adjusted to it but it happened often enough to notice. With the red, this is gone. I&rsquo;m not sure if it&rsquo;s smarter or if the acceleration takes care of it, but it never happens, or just happens far less.</p>

<p>All the buttons are 100% programmable in OSX/Windows via their driver. I havent tried on linux, but I&rsquo;m sure it is. The bar itself has a physical tensioner as well which is nice to add resistance. And as far as usability: it&rsquo;s great. The roller bar
is a physical left click if you press, and everything is in the right place. I dont have to move my hands <em>at all</em> to use it.</p>

<p><img class="left" src="http://marcyoung.us/images/red1.jpg">
<img class="left" src="http://marcyoung.us/images/red2.jpg"></p>

<p>The drawback is price. It&rsquo;s crazy expensive, and I got lucky to find it on ebay after months of searching/bidding for a low price. I&rsquo;m not sure it&rsquo;s worth the original MSRP, but I love it.</p>

<h2>Contourmouse Free2</h2>

<p>This one has most of the same pros as the Red, but I find myself getting annoyed at the physical bar occasionally. It&rsquo;s smaller than the red in terms of diameter, it&rsquo;s closer to the original contourmouse. It makes it a little harder to get your thumb on
and move freely just because it&rsquo;s thinner. The tensioner isnt that great, so sometimes after a long coding session when my hands get a little stiff the mouse shows my thumb shakiness a little on &ldquo;exact&rdquo; clicks like on small buttons. That&rsquo;s when I can tell
I&rsquo;ve been at it too long. And the original complaint about physical left/right exists here. I find myself out of space to go left or right and have to break focus to move the mouse over. If I were trying to do exact work like CAD/3d modelling I&rsquo;d probably
throw it out the window by this point. It&rsquo;s great, but it&rsquo;s not worth the price considering how much nicer the Red is. Also, after only a few weeks, the palm rest started coming apart, and I used a sticker to prevent it from spreading. I can tell you right
now though, the sticker is functionally part of it now. If I pull it off, the padding will come with it. They  call the pads replaceable, but that assumes you can find it. I can&rsquo;t find replacement pads that dont come with a full keyboard.</p>

<p><img class="left" src="http://marcyoung.us/images/free1.jpg">
<img class="left" src="http://marcyoung.us/images/free2.jpg"></p>

<p>This one is not worth the price, but I&rsquo;d buy it again if it were &lt; $60.</p>

<h2>Penclic NiceTouce T2</h2>

<p>This is the one I was iffy about. Functionally, it&rsquo;s great. They sent me the matching keyboard, the Penclic NiceTouch C2, which is a chiclet key style keyboard. Together they work fine. If you like chiclets it types and works great.
However, my biggest problem is not with the keyboard, but with the trackpad. As a trackpad, it&rsquo;s fine, but it doesn&rsquo;t support gestures or multi-finger. I&rsquo;ve become so used to being able to do two-finger scroll that it&rsquo;s frustrating to not have it.
There is a physical rotating key that lets you scroll left right, but the right side of my palm kept touching it and making my cursor jump in vim.</p>

<p><img class="left" src="http://marcyoung.us/images/t2_1.jpg">
<img class="left" src="http://marcyoung.us/images/t2_4.jpg">
<img class="left" src="http://marcyoung.us/images/t2_5.jpg">
<img class="left" src="http://marcyoung.us/images/t2_6.jpg"></p>

<p>My other complaint is with the buttons. They&rsquo;re not labeled or programmable so you <em>have</em> to read the booklet to know what buttons &frac34; do. They&rsquo;re also impossible to reach. The draw to the contourmouse design is that the bar clicks but also those buttons
are very reachable by your thumbs. You can put your hands on the Home keys and not  have to move your hands at all to be efficient. With the T2 the buttons are so far down that they&rsquo;re not reachable, meaning I have to move my hands to click them. At that
point I&rsquo;d rather have a mouse. Without two-finger scroll it means that I cant do anything except move my mouse up/down/left/right without moving my hands around.</p>

<p><img class="left" src="http://marcyoung.us/images/t2_3.jpg"></p>

<p>The only other complaint I have is that if you use the trackpad with a different keyboard (like my pok3r), it&rsquo;s too low and leave a huge gap vertically. There are no risers (like on most keyboard) to raise the trackpad, so I stuffed a piece of cardboard
under it, but that made it a bit wobbly. I could probably 3d print something, but that&rsquo;s pretty intense for an out-of-the-box experience. Lastly, the trackpad is <em>very</em> light. So light that it moves around while using it.  It probably only weighs a few
ounces which gives it a flemsy breakable feel. Having something that light on top of a  piece of cardboard created a very unstable setup.</p>

<p><img class="left" src="http://marcyoung.us/images/t2_2.jpg"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Up and Running With Bless and Enforced MFA - Part 2]]></title>
    <link href="http://marcyoung.us/post/bless-part2"/>
    <updated>2017-06-20T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/bless-part2</id>
    <content type="html"><![CDATA[<p>Part 2 of deploying Bless will focus on enforcing MFA and using Lyft’s client. <!-- more --></p>

<p>The problem at this point is that anyone in the ops group can bounce without MFA enforced. We can set up the lyft client, which enforces MFA, but if we dont make other changes, there’s no enforcement of MFA. ie you can still call the netflix client and bounce right in.</p>

<p>The other issue is that Netflix’s bless holds true the idea of a bastion host. In-house, we have IPSec tunnels from our VPC’s to our internal network, so I dont need to bounce through a bastion. So I want anyone to be able to bounce, given that they have permissions (ops) and they used MFA. Lyft’s doesn’t enforce the bastion concept, which is nice.</p>

<h1>Prerequisites</h1>

<p>In the IAM console in AWS, enable an MFA device for your user.</p>

<h2>Setting up the client</h2>

<p>I wrote a wrapper to simplify this. Feel free to not like it, but I put this in my <code>~/.bash_aliases</code> to make it easier:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function bounce() {
</span><span class='line'>  if [[ ! -d ~/.blessclient ]]; then
</span><span class='line'>    pushd . &gt;/dev/null
</span><span class='line'>    git clone https://github.com/lyft/python-blessclient.git ~/.blessclient
</span><span class='line'>    cd $_
</span><span class='line'>    make
</span><span class='line'>    popd &gt;/dev/null
</span><span class='line'>  fi
</span><span class='line'>  INTERNAL_IP=$(ifconfig | grep inet | grep 192 | awk '{ print $2}')
</span><span class='line'>  # This gets weird if you have wired and wifi hooked up (sometimes i do). It might allow the wrong IP and give you a crap error messsage.
</span><span class='line'>  if [[ $(ifconfig | grep inet | grep 192 | awk '{ print $2}' | wc -l) -gt 1 ]] && [[ -z ${BLESSFIXEDIP} ]]; then
</span><span class='line'>    echo "More than one internal ip found. Disable a network interface or provide it manually via env var 'BLESSFIXEDIP'"
</span><span class='line'>  else
</span><span class='line'>    FILE="$(mktemp)"
</span><span class='line'>    rm -rf ${FILE}*
</span><span class='line'>    ssh-keygen -f ${FILE} -N ""
</span><span class='line'>    BLESS_IDENTITYFILE=${FILE} BLESSFIXEDIP=${BLESSFIXEDIP:-${INTERNAL_IP}} ~/.blessclient/blessclient.run --host $1 --nocache --config ~/.blessclient/blessclient.cfg --region EAST && ssh -i ${FILE} ec2-user@$1
</span><span class='line'>  fi
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Now you can bounce with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bounce 10.0.3.7
</span><span class='line'>Generating public/private rsa key pair.
</span><span class='line'>Your identification has been saved in /var/folders/5j/n9trdvbn3qqdtkshkpvnrkhh0000gp/T/tmp.s2ZdeuJD.
</span><span class='line'>Your public key has been saved in /var/folders/5j/n9trdvbn3qqdtkshkpvnrkhh0000gp/T/tmp.s2ZdeuJD.pub.
</span><span class='line'>The key fingerprint is:
</span><span class='line'>SHA256:CizQBI/ROY8QIeiRjt7rY65jPc/oJDL3MA marcyoung@Admins-MacBook-Pro.local
</span><span class='line'>The key's randomart image is:
</span><span class='line'>+---[RSA 2048]----+
</span><span class='line'>|B*+.             |
</span><span class='line'>|++o              |
</span><span class='line'>|=..              |
</span><span class='line'>|.o.*.            |
</span><span class='line'>|. o  S           |
</span><span class='line'>|...+ . .         |
</span><span class='line'>| E .o.           |
</span><span class='line'>|oo= + .          |
</span><span class='line'>|.=*              |
</span><span class='line'>+----[SHA256]-----+
</span><span class='line'>Enter your AWS MFA code: 477821
</span><span class='line'>Requesting certificate for your public key (set BLESSQUIET=1 to suppress these messages)
</span><span class='line'>Finished getting certificate.
</span><span class='line'>Last login: Fri Jun 16 20:14:52 2017 from ip-192-168-1-124.ec2.internal
</span><span class='line'>
</span><span class='line'>       __|  __|_  )
</span><span class='line'>       _|  (     /   Amazon Linux AMI
</span><span class='line'>      ___|\___|___|
</span><span class='line'>
</span><span class='line'>https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/
</span><span class='line'>No packages needed for security; 2 packages available
</span><span class='line'>Run "sudo yum update" to apply all updates.
</span><span class='line'>[marc@server ~]$</span></code></pre></td></tr></table></div></figure>


<p>Nice! But again, MFA is used, not enforced. Lets change that.</p>

<p>I hinted at my group policy in part 1 for <code>ops</code> that looked like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_iam_group_policy" "bless-client" {
</span><span class='line'>    name = "bless-client_iam_policy"
</span><span class='line'>    group = "${aws_iam_group.ops.id}"
</span><span class='line'>    policy = &lt;&lt;EOF
</span><span class='line'>{
</span><span class='line'>    "Version": "2012-10-17",
</span><span class='line'>    "Statement": [
</span><span class='line'>      {
</span><span class='line'>        "Effect": "Allow",
</span><span class='line'>        "Action": "sts:AssumeRole",
</span><span class='line'>        "Resource": [
</span><span class='line'>          "${data.terraform_remote_state.bless_client_iam.bless-client-role-arn}"
</span><span class='line'>        ]
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "Action": "kms:Encrypt",
</span><span class='line'>        "Effect": "Allow",
</span><span class='line'>        "Resource": [
</span><span class='line'>          "${data.terraform_remote_state.kms.ops_bless_arn}"
</span><span class='line'>        ],
</span><span class='line'>        "Condition": {
</span><span class='line'>          "StringEquals": {
</span><span class='line'>            "kms:EncryptionContext:user_type": "user",
</span><span class='line'>            "kms:EncryptionContext:from": "$${aws:username}"
</span><span class='line'>          }
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>But in actuality, it should look more like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_iam_group_policy" "bless-client" {
</span><span class='line'>    name = "assume-bless-role"
</span><span class='line'>    group = "${aws_iam_group.ops.id}"
</span><span class='line'>    policy = &lt;&lt;EOF
</span><span class='line'>{
</span><span class='line'>  "Version": "2012-10-17",
</span><span class='line'>  "Statement": [
</span><span class='line'>    {
</span><span class='line'>      "Effect": "Allow",
</span><span class='line'>      "Action": "sts:AssumeRole",
</span><span class='line'>      "Resource": [
</span><span class='line'>        "${data.terraform_remote_state.bless_client_iam.bless-client-role-arn}"
</span><span class='line'>      ],
</span><span class='line'>      "Condition": {
</span><span class='line'>        "Bool": {
</span><span class='line'>          "aws:MultiFactorAuthPresent": "true"
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    },
</span><span class='line'>    {
</span><span class='line'>      "Effect": "Deny",
</span><span class='line'>      "Action": "sts:AssumeRole",
</span><span class='line'>      "Resource": [
</span><span class='line'>        "${data.terraform_remote_state.bless_client_iam.bless-client-role-arn}"
</span><span class='line'>      ],
</span><span class='line'>      "Condition": {"BoolIfExists": {"aws:MultiFactorAuthPresent": false}}
</span><span class='line'>    },
</span><span class='line'>    {
</span><span class='line'>      "Action": "kms:Encrypt",
</span><span class='line'>      "Effect": "Allow",
</span><span class='line'>      "Resource": [
</span><span class='line'>        "${data.terraform_remote_state.kms.ops_bless_arn}"
</span><span class='line'>      ],
</span><span class='line'>      "Condition": {
</span><span class='line'>        "StringEquals": {
</span><span class='line'>          "kms:EncryptionContext:user_type": "user",
</span><span class='line'>          "kms:EncryptionContext:from": "$${aws:username}"
</span><span class='line'>        },
</span><span class='line'>        "Bool": {
</span><span class='line'>          "aws:MultiFactorAuthPresent": "true"
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    },
</span><span class='line'>    {
</span><span class='line'>      "Action": "kms:Encrypt",
</span><span class='line'>      "Effect": "Deny",
</span><span class='line'>      "Resource": [
</span><span class='line'>        "${data.terraform_remote_state.kms.ops_bless_arn}"
</span><span class='line'>      ],
</span><span class='line'>      "Condition": {
</span><span class='line'>        "StringEquals": {
</span><span class='line'>          "kms:EncryptionContext:user_type": "user",
</span><span class='line'>          "kms:EncryptionContext:from": "$${aws:username}"
</span><span class='line'>        },
</span><span class='line'>        "BoolIfExists": {
</span><span class='line'>          "aws:MultiFactorAuthPresent": false
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  ]
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>What did we do? We basically said ops users can assume the bless-client role or call kms:Encrypt on that key, but only if they used MFA. If you try the original bless client now, it will fail.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Up and Running With Bless and Enforced MFA - Part 1]]></title>
    <link href="http://marcyoung.us/post/bless-part1"/>
    <updated>2017-06-20T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/bless-part1</id>
    <content type="html"><![CDATA[<p>I finally got Netflix’s <a href="http://github.com/netflix/bless">Bless</a> running in production using a forked version of Lyft’s <a href="https://github.com/lyft/python-blessclient">client</a>. This post will focus on the first and easier portion: Bless in Lambda <!-- more --></p>

<h1>Prerequisites</h1>

<p>Time and terraform. I like terraform because I dislike cloudformation. Feel free to adapt.</p>

<h2>Installing Bless</h2>

<p>This is actually the easiest part, because it’s straight forward. Side note: I like bless because of its simplicity. It uses lambda + KMS and nothing more. The permissions are stupid simple. The purpose, after talking to one of the guys behind it, was to make it feel native and un-intrusive. It works.</p>

<h2>Setup Config</h2>

<p>This was the hardest to get going, because configuration always is. The readme says to paste in a function to lambda to generate your password. But thats not needed with the super awesome lambda container from <a href="https://github.com/lambci/docker-lambda">lambci</a>. To do this, create a file function.py with the contents:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import boto3
</span><span class='line'>import base64
</span><span class='line'>import os
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>def lambda_handler(event, context):
</span><span class='line'>    region = os.environ['AWS_REGION']
</span><span class='line'>    client = boto3.client('kms', region_name=region)
</span><span class='line'>    response = client.encrypt(
</span><span class='line'>    KeyId='kms_key_id',
</span><span class='line'>    Plaintext='totallysecure'
</span><span class='line'>    )
</span><span class='line'>
</span><span class='line'>    ciphertext = response['CiphertextBlob']
</span><span class='line'>    return base64.b64encode(ciphertext)</span></code></pre></td></tr></table></div></figure>


<p>Now lets run that without using the real lambda. Make sure your access key/id have the required permissions to do <code>kms:Encrypt</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker run -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY=AWS_SECRET_ACCESS_KEY -e AWS_REGION=us-east-1 -v "$PWD":/var/task lambci/lambda:python2.7 function.lambda_handler
</span><span class='line'>START RequestId: 42f85048-91e1-4b48-9376-0563722616f0 Version: $LATEST
</span><span class='line'>END RequestId: 42f85048-91e1-4b48-9376-0563722616f0
</span><span class='line'>REPORT RequestId: 42f85048-91e1-4b48-9376-0563722616f0 Duration: 733 ms Billed Duration: 800 ms Memory Size: 1536 MB Max Memory Used: 25 MB
</span><span class='line'>"some base64 encoded key"</span></code></pre></td></tr></table></div></figure>


<h2>The Config</h2>

<p>This is an example of a finished config. Save it as <code>lambda_configs/bless_deploy.cfg</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Bless Options]
</span><span class='line'>certificate_validity_after_seconds = 120
</span><span class='line'>certificate_validity_before_seconds = 120
</span><span class='line'>entropy_minimum_bits = 2048
</span><span class='line'>random_seed_bytes = 256
</span><span class='line'>logging_level = INFO
</span><span class='line'>
</span><span class='line'>[Bless CA]
</span><span class='line'>
</span><span class='line'>us-east-1_password = some base64 encoded key from lambci/lambda
</span><span class='line'>ca_private_key_file = foo1.pem
</span><span class='line'>
</span><span class='line'>[KMS Auth]</span></code></pre></td></tr></table></div></figure>


<h2>Build</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virtualenv venv
</span><span class='line'>$ . venv/bin/activate
</span><span class='line'>$ pip install -r requirements.txt
</span><span class='line'>$ make publish </span></code></pre></td></tr></table></div></figure>


<h1>Deploy</h1>

<h2>IAM</h2>

<p>The first piece is the IAM portion for Bless. I need to allow it to:</p>

<ol>
<li>Generate random keys from KMS (obvious)</li>
<li>Decrypt the KMS key that’s the password for Bless. This is generated and</li>
<li>Create the log group (maybe not necesary since Lambda does that for you?)</li>
<li>Push logs</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_iam_role" "bless_lambda" {
</span><span class='line'>    name = "bless_lambda"
</span><span class='line'>    assume_role_policy = &lt;&lt;EOF
</span><span class='line'>{
</span><span class='line'>  "Version": "2012-10-17",
</span><span class='line'>  "Statement": [
</span><span class='line'>    {
</span><span class='line'>      "Action": "sts:AssumeRole",
</span><span class='line'>      "Principal": {
</span><span class='line'>        "Service": "lambda.amazonaws.com"
</span><span class='line'>      },
</span><span class='line'>      "Effect": "Allow",
</span><span class='line'>      "Sid": ""
</span><span class='line'>    }
</span><span class='line'>  ]
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "aws_iam_role_policy" "bless_lambda" {
</span><span class='line'>    name = "bless_lambda"
</span><span class='line'>    role = "${aws_iam_role.bless_lambda.id}"
</span><span class='line'>    policy = &lt;&lt;EOF
</span><span class='line'>{
</span><span class='line'>    "Version": "2012-10-17",
</span><span class='line'>    "Statement": [
</span><span class='line'>        {
</span><span class='line'>          "Sid": "Stmt1443036478000",
</span><span class='line'>          "Effect": "Allow",
</span><span class='line'>          "Action": [
</span><span class='line'>              "kms:GenerateRandom",
</span><span class='line'>              "kms:Decrypt"
</span><span class='line'>          ],
</span><span class='line'>          "Resource": [
</span><span class='line'>              "${data.terraform_remote_state.kms.ops_bless_arn}"
</span><span class='line'>          ]
</span><span class='line'>        },
</span><span class='line'>        {
</span><span class='line'>            "Effect": "Allow",
</span><span class='line'>            "Action": "logs:CreateLogGroup",
</span><span class='line'>            "Resource": "arn:aws:logs:us-east-1:*:*"
</span><span class='line'>        },
</span><span class='line'>        {
</span><span class='line'>            "Effect": "Allow",
</span><span class='line'>            "Action": [
</span><span class='line'>                "logs:CreateLogStream",
</span><span class='line'>                "logs:PutLogEvents"
</span><span class='line'>            ],
</span><span class='line'>            "Resource": [
</span><span class='line'>                "arn:aws:logs:us-east-1:*:log-group:/aws/lambda/*"
</span><span class='line'>            ]
</span><span class='line'>        }
</span><span class='line'>    ]
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>KMS</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_kms_key" "ops-bless" {
</span><span class='line'>    description             = "KMS key for Bless"
</span><span class='line'>    deletion_window_in_days = 7
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "aws_kms_alias" "ops-bless" {
</span><span class='line'>    name          = "alias/ops/bless"
</span><span class='line'>    target_key_id = "${aws_kms_key.ops-bless.key_id}"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>output "ops_bless_arn" {
</span><span class='line'>  value = "${aws_kms_key.ops-bless.arn}"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>Client</h1>

<h2>Client IAM role to assume</h2>

<p>It basically just allows the invocation of our deployed function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_iam_role" "bless-client" {
</span><span class='line'>    name               = "bless-client"
</span><span class='line'>    path               = "/"
</span><span class='line'>    assume_role_policy = &lt;&lt;EOF
</span><span class='line'>{
</span><span class='line'>    "Version": "2012-10-17",
</span><span class='line'>    "Statement": [
</span><span class='line'>        {
</span><span class='line'>            "Action": "lambda:InvokeFunction",
</span><span class='line'>            "Effect": "Allow",
</span><span class='line'>            "Resource": [
</span><span class='line'>                "${data.terraform_remote_state.lambda-bless.bless_arn}"
</span><span class='line'>            ]
</span><span class='line'>        }
</span><span class='line'>    ]
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>I added this to our <code>ops</code> IAM group so that any ops person can assume the role or use <code>kms:Encrypt</code> from the bless KMS key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_iam_group_policy" "bless-client" {
</span><span class='line'>    name = "bless-client_iam_policy"
</span><span class='line'>    group = "${aws_iam_group.ops.id}"
</span><span class='line'>    policy = &lt;&lt;EOF
</span><span class='line'>{
</span><span class='line'>    "Version": "2012-10-17",
</span><span class='line'>    "Statement": [
</span><span class='line'>      {
</span><span class='line'>        "Effect": "Allow",
</span><span class='line'>        "Action": "sts:AssumeRole",
</span><span class='line'>        "Resource": [
</span><span class='line'>          "${data.terraform_remote_state.bless_client_iam.bless-client-role-arn}"
</span><span class='line'>        ]
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "Action": "kms:Encrypt",
</span><span class='line'>        "Effect": "Allow",
</span><span class='line'>        "Resource": [
</span><span class='line'>          "${data.terraform_remote_state.kms.ops_bless_arn}"
</span><span class='line'>        ],
</span><span class='line'>        "Condition": {
</span><span class='line'>          "StringEquals": {
</span><span class='line'>            "kms:EncryptionContext:user_type": "user",
</span><span class='line'>            "kms:EncryptionContext:from": "$${aws:username}"
</span><span class='line'>          }
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Client config</h2>

<p>This is an example of what my client config looks like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[MAIN]
</span><span class='line'>region_aliases: east
</span><span class='line'>kms_service_name: bless
</span><span class='line'>bastion_ips: 192.168.1.6
</span><span class='line'>remote_user: ec2-user
</span><span class='line'>
</span><span class='line'>[CLIENT]
</span><span class='line'>domain_regex: (.*\.mycompany\.com|.*\.example\.net|\A10\.[0-9](?:\.[0-9]{1,3}){2}\Z)$
</span><span class='line'>cache_dir: .bless/session
</span><span class='line'>cache_file: bless_cache.json
</span><span class='line'>mfa_cache_dir: .aws/session
</span><span class='line'>mfa_cache_file: token_cache.json
</span><span class='line'>ip_urls: http://api.ipify.org, http://canihazip.com
</span><span class='line'>update_script: update_blessclient.sh
</span><span class='line'>
</span><span class='line'>[LAMBDA]
</span><span class='line'>user_role: bless-client
</span><span class='line'>account_id: my account id
</span><span class='line'>functionname: bless
</span><span class='line'>functionversion: $LATEST
</span><span class='line'>certlifetime: 120
</span><span class='line'>ipcachelifetime: 120
</span><span class='line'>timeout_connect: 30
</span><span class='line'>timeout_read: 30
</span><span class='line'>
</span><span class='line'>[REGION_EAST]
</span><span class='line'>awsregion: us-east-1
</span><span class='line'>kmsauthkey: my kms id that i used for the original password encrypt</span></code></pre></td></tr></table></div></figure>


<h1>Test</h1>

<p>You should now have a lambda that can generate certificates to use. You’ll need to put the public keys from <code>foo1.pub</code> and <code>foo2.pub</code> into your servers at <code>/etc/ssh/cas.pub</code> and add <code>TrustedUserCAKeys /etc/ssh/cas.pub</code> to <code>/etc/ssh/sshd_config</code> You can test this with their client:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function bounce () {
</span><span class='line'>  FILE="$(mktemp)"
</span><span class='line'>  rm -rf ${FILE}
</span><span class='line'>  ssh-keygen -f ${FILE} -N ""
</span><span class='line'>  ./bless_client.py \
</span><span class='line'>    us-east-1 \
</span><span class='line'>    bless \
</span><span class='line'>    testdev $(curl --silent http://ipecho.net/plain) \
</span><span class='line'>    ec2-user $(ifconfig | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1') \
</span><span class='line'>    "" \
</span><span class='line'>    ${FILE}.pub ${FILE}-cert.pub
</span><span class='line'>  ssh -i ${FILE} ec2-user@$1 "${@:2}"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>$ bounce 10.0.0.19</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[oVirt and Vagrant]]></title>
    <link href="http://marcyoung.us/post/ovirt4-vagrant"/>
    <updated>2017-02-10T00:00:00-06:00</updated>
    <id>http://marcyoung.us/post/ovirt-vagrant</id>
    <content type="html"><![CDATA[<p>I wrote a <a href="https://www.ovirt.org/blog/2017/02/using-oVirt-vagrant/">blog post</a> over on oVirt about how to use the most recent release of my new vagrant oVirt v4 provider.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Homemade planck]]></title>
    <link href="http://marcyoung.us/post/planck"/>
    <updated>2017-01-18T00:00:00-06:00</updated>
    <id>http://marcyoung.us/post/planck</id>
    <content type="html"><![CDATA[<p>I made a super tedious keyboard.<!-- more --></p>

<p>I’ve owned a Das Keyboard Model S Ultimate for about 3 years now. It was mostly to get into keyboards and try out a nice mechanical one. I still love it, but after getting more interested in them, I decided to build a planck.</p>

<p>A planck is basically an ortholinear keyboard (meaning the keys are in perfect columns and rows) and has 47-48 keys (4x12 called a 40%).</p>

<p>Basically your fingers do the work and your thumbs toggle the keyboard to differently layers.</p>

<p>I 3d printed the case, then wired up the columns and rows using 1N4148 diodes to a teensy. My first iteration used what looked like a really awesome 3d printed base, but it ended up overwhelming me because the wires had to be routed through very very tiny spaces, and my soldering iron: a) needed some love and b) kept melting the 3d printed base (because of all the tight spots). I then printed a much different and standard base and things went smoother.</p>

<p>I also got overwhelmed with the <a href="https://github.com/tmk/tmk_keyboard">TMK firmware</a>. Everyone says it’s easy, and you’d think as a programmer I’d have some ease with it, but it’s super confusing and talks about bit shifting like it’s just adding numbers and you should be able to do it in your sleep. Then I found <a href="http://kb.sized.io/">this site</a> and was done in under an hour. Obligatory pictures.</p>

<p><img class="left" src="http://marcyoung.us/images/IMG_20160927_062158.jpg" title="keyboard 1" >
<img class="left" src="http://marcyoung.us/images/IMG_20161224_143647.jpg" title="keyboard 1" >
<img class="left" src="http://marcyoung.us/images/IMG_20161225_050545.jpg" title="keyboard 1" >
<img class="left" src="http://marcyoung.us/images/IMG_20170104_145354.jpg" title="keyboard 1" ></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AWS ECS Hot/Warm ELK + Curator Part 4 - Curator]]></title>
    <link href="http://marcyoung.us/post/dockerized-elk-part-4"/>
    <updated>2016-08-08T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/dockerized-elk-part4</id>
    <content type="html"><![CDATA[<p>The previous part focused on getting Kibana up. This one focuses on getting Curator <!-- more --></p>

<h1>Disclaimer</h1>

<p>I&rsquo;m redacting any information that might seem sensitive such as account numbers. Use your discretion and make sure you use values that make sense for things blacked out in images or in <code>{}</code> notation.</p>

<h1>Part 2 - Curator</h1>

<p>This is the coolest part of the whole stack.</p>

<p>We&rsquo;re basically going to build/deploy a docker image for Curator, then upload a cloudformation template that creates a Lambda function to run it.</p>

<p>The lambda function will have a trigger of your choice (probably a scheduled event for once a day if I had to guess) and will run two tasks.</p>

<p>Task 1 is a rotate warm task that will tell Elasticsearch to move any indexes to warm that (in this case) are 0 days old (for demo purposes).
Task 2 is a delete task that tells Elasticsearch to delete any indexes older than 14 days.</p>

<p>You can expand this to stagger them, take snapshots, etc. This allows you to have schedules that define how the data moves from box to box or to backups!</p>

<p>First thing we need to do is build the container and push it to ECR.</p>

<p>In the ECR portion of the AWS console, create a new repository called <code>test/curator</code>.</p>

<p>Then in your console for <a href="https://github.com/myoung34/elk-docker-aws/blob/master/curator/Dockerfile">the curator dockerfile</a> run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker build -t curator:local .
</span><span class='line'>docker tag curator:local \
</span><span class='line'>   {acctnum}.dkr.ecr.us-east-1.amazonaws.com/test/curator:latest
</span><span class='line'>$(aws ecr get-login)
</span><span class='line'>docker push {acctnum}.dkr.ecr.us-east-1.amazonaws.com/test/curator:latest</span></code></pre></td></tr></table></div></figure>


<p>Once this is pushed you can verify it by looking for a tag <code>latest</code> in your <code>test/curator</code> ECR repository.</p>

<p>Next upload <a href="https://github.com/myoung34/elk-docker-aws/blob/master/curator/cloudformation.json">this cloudformation template</a> to Cloudformation (modifying the parameters as you need).</p>

<p><img src="../../images/elk/curator_cft_params.png" alt="" /></p>

<p>Once it is complete, go to the Lambda portion of AWS and click your function that was created. You can test it by clicking &ldquo;Test&rdquo; and just hitting &ldquo;submit&rdquo;.</p>

<p>You will see some output such as:</p>

<p><img src="../../images/elk/curator_lambda.png" alt="" /></p>

<p>If you go to the ECS console quickly you will see two tasks have been created and are being run for the first time (will be in pending for a minute while the image is being pulled to the instance running it).</p>

<p><img src="../../images/elk/curator_delete_task.png" alt="" /></p>

<p><img src="../../images/elk/curator_rotate_warm_task.png" alt="" /></p>

<p>And now if you look at your kopf plugin you will see the data move from the &ldquo;hot&rdquo; node:</p>

<p><img src="../../images/elk/curator_before.png" alt="" /></p>

<p>To eventually the &ldquo;warm&rdquo; node:</p>

<p><img src="../../images/elk/curator_after.png" alt="" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AWS ECS Hot/Warm ELK + Curator Part 3 - Kibana]]></title>
    <link href="http://marcyoung.us/post/dockerized-elk-part-3"/>
    <updated>2016-08-08T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/dockerized-elk-part3</id>
    <content type="html"><![CDATA[<p>The previous part focused on getting logstash up. This one focuses on getting Kibana <!-- more --></p>

<h1>Disclaimer</h1>

<p>I&rsquo;m redacting any information that might seem sensitive such as account numbers. Use your discretion and make sure you use values that make sense for things blacked out in images or in <code>{}</code> notation.</p>

<h1>Part 2 - Kibana</h1>

<p>First thing we need to do is build the container and push it to ECR.</p>

<p>In the ECR portion of the AWS console, create a new repository called <code>test/kibana</code>.</p>

<p>Then in your console for <a href="https://github.com/myoung34/elk-docker-aws/blob/master/kibana/Dockerfile">the kibana dockerfile</a> run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker build -t kibana:local .
</span><span class='line'>docker tag kibana:local \
</span><span class='line'>   {acctnum}.dkr.ecr.us-east-1.amazonaws.com/test/kibana:latest
</span><span class='line'>$(aws ecr get-login)
</span><span class='line'>docker push {acctnum}.dkr.ecr.us-east-1.amazonaws.com/test/kibana:latest</span></code></pre></td></tr></table></div></figure>


<p>Once this is pushed you can verify it by looking for a tag <code>latest</code> in your <code>test/kibana</code> ECR repository.</p>

<p>Next upload <a href="https://github.com/myoung34/elk-docker-aws/blob/master/kibana/cloudformation.json">this cloudformation template</a> to Cloudformation (modifying the parameters as you need).</p>

<p>It will look almost exactly like the logstash upload in terms of parameters.</p>

<p>You now have a kibana instance! My next step would be to configure a Route53 domain name to point to the kibana load balancer so you can have real SSL without any chain issues.</p>

<h1>Takeaways</h1>

<p>Similar to what we did with elasticsearch and logstash, kibana is listening on port <code>5601</code> via HTTPS. It uses self-signed SSL certificates. The dockerfile is actually identical to the verified one on the Dockerhub, except I expanded the <code>docker-entrypoint.sh</code> to take more parameters since the base one doesn&rsquo;t allow much configurability: <a href="https://github.com/docker-library/kibana/pull/45">https://github.com/docker-library/kibana/pull/45</a></p>

<p>If you browse to your ELB or route53 entry on port 443, you&rsquo;ll be greeted by kibana.</p>

<p><img src="../../images/elk/kibana_first.png" alt="" /></p>

<p>If you configure your index to <code>test-*</code> your dashboard will show the logs Logstash ingested!</p>

<p><img src="../../images/elk/kibana_dash.png" alt="" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AWS ECS Hot/Warm ELK + Curator Part 2 - Logstash]]></title>
    <link href="http://marcyoung.us/post/dockerized-elk-part-2"/>
    <updated>2016-08-08T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/dockerized-elk-part2</id>
    <content type="html"><![CDATA[<p>The previous part focused on getting the ECS cluster, ECR repos, and Elasticsearch up. This one focuses on getting Logstash <!-- more --></p>

<h1>Disclaimer</h1>

<p>I&rsquo;m redacting any information that might seem sensitive such as account numbers. Use your discretion and make sure you use values that make sense for things blacked out in images or in <code>{}</code> notation.</p>

<h1>Part 2a - Logstash</h1>

<p>First thing we need to do is build the container and push it to ECR.</p>

<p>In the ECR portion of the AWS console, create a new repository called <code>test/logstash</code>.</p>

<p>Then in your console for <a href="https://github.com/myoung34/elk-docker-aws/blob/master/logstash/Dockerfile">the logstash dockerfile</a> run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker build -t logstash:local .
</span><span class='line'>docker tag logstash:local \
</span><span class='line'>   {acctnum}.dkr.ecr.us-east-1.amazonaws.com/test/logstash:latest
</span><span class='line'>$(aws ecr get-login)
</span><span class='line'>docker push {acctnum}.dkr.ecr.us-east-1.amazonaws.com/test/logstash:latest</span></code></pre></td></tr></table></div></figure>


<p>Once this is pushed you can verify it by looking for a tag <code>latest</code> in your <code>test/logstash</code> ECR repository.</p>

<p>Next upload <a href="https://github.com/myoung34/elk-docker-aws/blob/master/logstash/cloudformation.json">this cloudformation template</a> to Cloudformation (modifying the parameters as you need).</p>

<p><img src="../../images/elk/logstash_cft.png" alt="" /></p>

<p>You now have a listening logstash instance! My next step would be to configure a Route53 domain name to point to the logstash load balancer so you can have real SSL without any chain issues.</p>

<h1>Takeaways</h1>

<p>Similar to what we did with elasticsearch, logstash is listening on port <code>5000</code> for beats input. It uses self-signed SSL certificates. Most beats forwarders won&rsquo;t play nice with that out of the box, but if you configure Route53 to point to the ELB and use ACM, it will be valid SSL. The load balancer will use TCP to send to the logstash instances and not care that it is self-signed.</p>

<p>The <a href="https://github.com/myoung34/elk-docker-aws/blob/master/logstash/logstash.conf">logstash configuration file</a> uses dynamic indexes, so whatever you set <code>document_type</code> on your beats configuration to will become the index.</p>

<h1>Part 2b - Send to logstash</h1>

<p>Install the latest stable logstash and use this filebeat configuration to get ready to ship:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>filebeat:
</span><span class='line'>  prospectors:
</span><span class='line'>    -
</span><span class='line'>      paths:
</span><span class='line'>        - "/var/log/test/*"
</span><span class='line'>      encoding: plain
</span><span class='line'>      input_type: log
</span><span class='line'>      fields_under_root: true
</span><span class='line'>      document_type: test
</span><span class='line'>output:
</span><span class='line'>  logstash:
</span><span class='line'>    hosts: ["log-test.dev.mydom.com:5000"]</span></code></pre></td></tr></table></div></figure>


<p>Next make sure that directory exists via <code>sudo mkdir /var/log/test</code> and start the service (depends on your OS): <code>sudo service filebeat start</code>.</p>

<p>Lastly, lets send something to logstash: <code>echo asdf | sudo tee -a /var/log/test/$(uuidgen)</code>. That will generate a random file and put <code>asdf</code> into it. It should show up in your kopf plugin to view:</p>

<p><img src="../../images/elk/logstash_kopf.png" alt="" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AWS ECS Hot/Warm ELK + Curator Part 1 - Elasticsearch]]></title>
    <link href="http://marcyoung.us/post/dockerized-elk-part-1"/>
    <updated>2016-08-08T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/dockerized-elk-part1</id>
    <content type="html"><![CDATA[<p>This will be a write-up on how to get a self-healing and self-curating SSL-enabled Hot/Warm ELK stack using ECS and lambda <!-- more --></p>

<h1>Disclaimer</h1>

<p>I&rsquo;m redacting any information that might seem sensitive such as account numbers. Use your discretion and make sure you use values that make sense for things blacked out in images or in <code>{}</code> notation.</p>

<h1>Part 1a - ECS Base Instances</h1>

<p>This is actually one of the easier pieces. We need a base ECS cluster to run our tasks on. <a href="https://github.com/myoung34/elk-docker-aws/blob/master/ecs_base/cloudformation.json">This cloudformation template</a> assumes your VPC is connectible, etc. If your VPC is compatible, just upload that file in cloudformation and when it&rsquo;s done, you&rsquo;ll have a cluster ready!</p>

<p>The params tab:</p>

<p><img src="../../images/elk/elk_base_cft.png" alt="" /></p>

<p>After completion:</p>

<p><img src="../../images/elk/elk_base_cft_output.png" alt="" /></p>

<p>If you were to go to your ECS tab in your AWS console, you will see a new cluster with the name <code>elk-stack-ECSCluster-1A5AXF087VXOD</code> and eventually you would have 4 EC2 instances available for running tasks.</p>

<h1>Part 1b - Elasticsearch</h1>

<p>First thing we need to do is build the container and push it to ECR.</p>

<p>In the ECR portion of the AWS console, create a new repository called <code>test/elasticsearch</code>.</p>

<p>Then in your console for <a href="https://github.com/myoung34/elk-docker-aws/tree/master/elasticsearch">the elasticsearch dockerfile</a> run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker build -t elasticsearch:local .
</span><span class='line'>docker tag elasticsearch:local \
</span><span class='line'>   {acctnum}.dkr.ecr.us-east-1.amazonaws.com/test/elasticsearch:latest
</span><span class='line'>$(aws ecr get-login)
</span><span class='line'>docker push {acctnum}.dkr.ecr.us-east-1.amazonaws.com/test/elasticsearch:latest</span></code></pre></td></tr></table></div></figure>


<p>Once this is pushed you can verify it by looking for a tag <code>latest</code> in your <code>test/elasticsearch</code> ECR repository.</p>

<p>Next upload <a href="https://github.com/myoung34/elk-docker-aws/blob/master/elasticsearch/cloudformation.json">this cloudformation template</a> to Cloudformation (modifying the parameters as you need).</p>

<p>The parameters I used:</p>

<p><img src="../../images/elk/elasticsearch_cft_params.png" alt="" /></p>

<p>And the output tab:</p>

<p><img src="../../images/elk/elasticsearch_cft_output.png" alt="" /></p>

<p>If you paid enough attention to the code in the <a href="https://github.com/myoung34/elk-docker-aws/blob/master/elasticsearch/docker-entrypoint.sh">docker-entrypoint.sh</a> file you might notice this line: <code>export NODE_TYPE=$([[ `echo $((1 + RANDOM % 2))` -eq "1" ]] &amp;&amp; echo warm || echo hot)</code>.</p>

<p>That, along with the <a href="https://github.com/myoung34/elk-docker-aws/blob/master/elasticsearch/elasticsearch.yml">elasticsearch configuration yaml</a>, namely the line: <code>node.box_type: ${NODE_TYPE}</code> gives you a random 50/50 chance of getting a &ldquo;hot&rdquo; or &ldquo;warm&rdquo; node. <a href="https://www.elastic.co/blog/hot-warm-architecture">The hot/warm architecture is outlined here</a> but basically you&rsquo;re going to have nodes that have attributes <code>box_type: hot</code> or <code>box_type: warm</code>. We&rsquo;ll go over how the data matters later, but for now you can verify that like in these screen shots by browsing to your elastic load balancer such as: <code>internal-elasticse-ESElasti-WYA9ZLRBVV8X-214980960.us-east-1.elb.amazonaws.com:9200/_plugin/kopf</code> and viewing the attributes for your node.</p>

<p><img src="../../images/elk/elasticsearch_kopf_hot.png" alt="" /></p>

<p><img src="../../images/elk/elasticsearch_kopf_warm.png" alt="" /></p>

<p>You now have an SSL-enabled ELK stack that will have hot or warm nodes.</p>

<h1>Takeaways</h1>

<p>SSL is enabled by using NGINX as an SSL-listener in front of the ES port <code>9200</code> using self-signed certs. Elasticsearch is configured to use <code>19200</code> but broadcast <code>9200</code>. This lets the nodes themselves talk over SSL using insecure TLS, but they look normal to the outside world. The Load balancer uses ACM from Amazon with a real domain <code>*.dev.mydom.com</code> (in my screenshots) to terminate SSL with a real chain, but communicates over TCP to the ES nodes to the self-signed server.</p>

<p>The reason for doing this: things like to be able to verify the chain, and don&rsquo;t like self-signed certs. As you see in my screen shot, since I used route53 to point <code>es-test.dev.mydom.com</code> to the ELB (which uses a valid ACM cert), everything is encrypted but outward facing services will not have chain errors.</p>

<p>Hot-warm could be better implemented, but for demonstration purposes, 50/50 is fine if you spin up 4+ nodes. If you only use 2 ECS tasks such as the screen shots, you might end up with both hot or both warm. If you&rsquo;re following along, you&rsquo;ll want at least one of each for curator to make sense.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[My Thoughts after six months of Elastic Beanstalk.]]></title>
    <link href="http://marcyoung.us/post/six-months-of-beanstalk"/>
    <updated>2015-11-16T00:00:00-06:00</updated>
    <id>http://marcyoung.us/post/six-months-of-beanstalk</id>
    <content type="html"><![CDATA[<p>We&rsquo;ve been using pure beanstalk at my current gig for six months and here are my thoughts. <!-- more --></p>

<p>I&rsquo;ll start off with the tl;dr: I like beanstalk a lot. When it fits.</p>

<p>I&rsquo;ve written enought deployment mechanisms to go a little crazy in my time. From tagging code in SVN and pushing it to a central store, to purely puppet provisioned instances, to microservices with ad-hoc AMIs to beanstalk. And beanstalk works. If you have a <em>traditional</em> application (by that I mean some consumers, some APIs, and a database of some sort), beanstalk is the (insert here).</p>

<p>Our current stack includes:</p>

<ul>
<li>A backend rails API.</li>
<li>A front-end javascript CMS.</li>
<li>An ad-hoc CRUD API written in rails.</li>
<li>A javascript web-embed written in node.</li>
</ul>


<p>We use jenkins to deploy code changes once tests pass.</p>

<p>And I&rsquo;ve got to say: I&rsquo;m not unhappy. There are very very few tweaks to make any more.</p>

<ul>
<li>All of these have multiple environments (dev/uat/prod), of which dev and uat shut down at night and on weekends.</li>
<li>Deployment includes rollbacks and notifications on failure.</li>
<li>Things auto-scale as expected.</li>
<li>You get all the metrics you really care about out of the box.</li>
</ul>


<p>That said: if it doesn&rsquo;t fit your stack, don&rsquo;t hamstring it. There are many good deployment mechanisms out there, and if your application does not easily fit into the peg that is beanstalk: find something else. We attempted to use it as a deployment mechanism for our cache layer and it failed horribly. Was it because there is no built in support in beanstalk? Yes. But It would be really nice to see beanstalk provide a boiler plate type set up like a template. Basically you just use their default AWS Linux image with no framework on it, provide the deployment scripts, and be able to manage it via beanstalk. That would be fantastic.</p>

<p>The only downside that I have found is that I would really like to re-do our base architecture at AWS to be code-based.
I&rsquo;m pretty much sold on Terraform, but that is my personal choice, and I would really love to see first-hand beanstalk support there. While not a criticism of beanstalk, I&rsquo;ll just be happy and watch <a href="https://github.com/hashicorp/terraform/issues/2799">this issue on terraform about the topic</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Fighting a nasty AWS bug for Beanstalk Leader Election]]></title>
    <link href="http://marcyoung.us/post/beanstalk-leader"/>
    <updated>2015-10-20T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/beanstalk-leader</id>
    <content type="html"><![CDATA[<p>In the last few months I&rsquo;ve been working to move my latest employer to AWS from Heroku and discovered a very nasty bug. <!-- more -->
The move was due to a lot of issues, the least of which being the cost of heroku compared to using what they implement.</p>

<p>None-the-less, everything went smoothly and the API went from roughly 80% uptime to 99.9%.
The cool thing: we used timed auto-scaling to shut down our dev/test instances at night time and on weekends. This saved <em>alot</em> of money. (remember this part).</p>

<p>After about two months, we discovered migrations in our rails application stopped. The code would deploy fine, but migrations just didn&rsquo;t. After much trial and error
it turned out to only happen on dev and test (not production). Parsing the web of beanstalks deployment framework, it turns out they have the concept of a leader. This is good. With the concept of a leader, you ensure that you can deploy to fleets in bulk and things that are stateful will only be run once (on the leader). One of these things is rails migrations, which makes perfect sense.</p>

<p>Somehow, the idea of our leader was lost. Out of all of our instances (2 in dev), neither one was considered a leader. Dropping that to a single instance, you would think: there&rsquo;s your leader right there. Nope.</p>

<p>Through much debugging with AWS support, we discovered that the implementation is based somewhat loosely <a href="https://github.com/blake-education/aws-cfn-bootstrap/blob/master/cfnbootstrap/cfn_client.py">on this</a>.</p>

<p>Turns out that a leader is elected once in the lifecycle of a beanstalk <em>application</em> and is passed around as the instances scale. If all instances are lost simaeltaneously, that leader is gone, and that&rsquo;s the bug. This could be problematic if you&rsquo;re not careful, but beanstalk makes it stupid simple to make sure instances are almost always available. It would take something crazy to lose all at once.</p>

<p>Like shutting down all instances at night.</p>

<p>As of now, the workaround has been to set an environment variable <code>EB_IS_COMMAND_LEADER</code> to <code>true</code>, and set our deployment to 1 at a time. While it works, it ties us back to beanstalks&#8217; internalness and makes our deployment much slower. Not only because it deploys to one at a time, but because each instance is going to run migrations even when not necessary.</p>

<p>Update: they&rsquo;ve fixed it with their latest update as of 11/15/2015. I removed the environment variable and deployed to a fleet, and it behaved as expected</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Purging old beanstalk versions]]></title>
    <link href="http://marcyoung.us/post/beanstalk-purge"/>
    <updated>2015-08-25T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/beanstalk-purge</id>
    <content type="html"><![CDATA[<p>I recently found out that you can have at most 500 application versions across beanstalk. I wrote a small script to purge it of old ones<!-- more --></p>

<p>I&rsquo;m a big fan of micro-deployments, however that seems to have caused a headache lately (and it turns out you don&rsquo;t want to find this out when you absolutely need to deploy).</p>

<p>My first attempt was to just browse to the S3 folder for our applications and purge them from S3 by the oldest ones, but that could cause a problem if you delete the archive for a currently deployed version. Also, as it turns out, Beanstalk caches this object list, so you still have to go to the EB console and click &lsquo;Refresh&rsquo; in the application versions list.</p>

<p>The better solution was to write a small ruby snippet to run on cron. It will get all application versions, subtract currently deployed ones, sort by date created, and purge all except &lsquo;x&rsquo; many.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require 'aws-sdk'
</span><span class='line'>
</span><span class='line'>MAX_VERSIONS=50
</span><span class='line'>elasticbeanstalk = Aws::ElasticBeanstalk::Client.new(region: 'us-east-1')
</span><span class='line'>
</span><span class='line'>short_versions_to_keep = elasticbeanstalk.describe_environments.environments.each.map { |v| "#{v.application_name}+#{v.version_label}" }
</span><span class='line'>
</span><span class='line'>version_eligible_for_delete = {}
</span><span class='line'>elasticbeanstalk.describe_application_versions.application_versions.each do |av|
</span><span class='line'>  short_version = "#{av.application_name}+#{av.version_label}"
</span><span class='line'>  next if short_versions_to_keep.include? short_version
</span><span class='line'>  version_eligible_for_delete[av.application_name] ||= {}
</span><span class='line'>  version_eligible_for_delete[av.application_name][av.version_label] = av
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>version_eligible_for_delete.each do |key, value|
</span><span class='line'>  version_eligible_for_delete[key] = value.sort { |a,b| a[1].date_created &lt;=&gt; b[1].date_created }
</span><span class='line'>  if version_eligible_for_delete[key].size &lt;=MAX_VERSIONS
</span><span class='line'>    puts "#{key} has only #{version_eligible_for_delete[key].size} versions. Skipping"
</span><span class='line'>    next
</span><span class='line'>  end
</span><span class='line'>  version_eligible_for_delete[key][0..version_eligible_for_delete[key].size-MAX_VERSIONS].each do |a|
</span><span class='line'>    puts "Deleting #{a[1].application_name}: #{a[1].version_label}"
</span><span class='line'>    elasticbeanstalk.delete_application_version(application_name: a[1].application_name, version_label: a[1].version_label)
</span><span class='line'>    sleep 1
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Adafruit PiGrrl Pocket Build]]></title>
    <link href="http://marcyoung.us/post/pigrrl-pocket"/>
    <updated>2015-08-20T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/pigrrl</id>
    <content type="html"><![CDATA[<p>After building the arcade cabinet I saw the PiGrrl Pocket and unfortunately for my pocket: I made one as well. <!-- more --></p>

<p>The Adafruit guide was pretty straight forward and I only blew one raspberry pi in the process (make sure you don&rsquo;t skip the part about disabling the TFT backlight or you&rsquo;ll cross wires during the troubleshooting phase).</p>

<p><img class="left" src="http://marcyoung.us/images/pigrrl1.jpg" title="cabinet 1" >
<img class="left" src="http://marcyoung.us/images/pigrrl2.jpg" title="cabinet 2" >
<img class="left" src="http://marcyoung.us/images/pigrrl3.jpg" title="cabinet 3" >
<img class="left" src="http://marcyoung.us/images/pigrrl4.jpg" title="cabinet 4" >
<img class="left" src="http://marcyoung.us/images/pigrrl5.jpg" title="cabinet 5" >
<img class="left" src="http://marcyoung.us/images/pigrrl6.jpg" title="cabinet 6" >
<img class="left" src="http://marcyoung.us/images/pigrrl7.jpg" title="cabinet 7" >
<img class="left" src="http://marcyoung.us/images/pigrrl8.jpg" title="cabinet 8" >
<img class="left" src="http://marcyoung.us/images/pigrrl9.jpg" title="cabinet 9" >
<img class="left" src="http://marcyoung.us/images/pigrrl10.jpg" title="cabinet 10" >
<img class="left" src="http://marcyoung.us/images/pigrrl11.jpg" title="cabinet 11" ></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[My First (and likely last) MAME cabinet build]]></title>
    <link href="http://marcyoung.us/post/mame-cabinet"/>
    <updated>2015-08-19T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/cabinet</id>
    <content type="html"><![CDATA[<p>I decided many months ago to build a bar-top cabinet. After many frustrations and failed attempts: it&rsquo;s done.<!-- more --></p>

<p>It was fairly simple after getting the table saw I needed and some parts later on.
Basically it was a fly-by-your seat design with some generic parts.</p>

<ul>
<li>Raspberry Pi running PiPlay</li>
<li>A super cheap <a href="http://www.panelook.com/EJ080NA-04C_Innolux_8.0_LCM_overview_12715.html">8&#8221; LCD with LVDS to HDMI/Composite out</a></li>
<li>Wood.</li>
<li>Arcade buttons and a USB controller for them.</li>
</ul>


<p>After giving up and restarting a few times, lo&#8217; and behold.</p>

<p><img class="left" src="http://marcyoung.us/images/cabinet1.jpg" title="cabinet 1" >
<img class="left" src="http://marcyoung.us/images/cabinet2.jpg" title="cabinet 2" >
<img class="left" src="http://marcyoung.us/images/cabinet3.jpg" title="cabinet 3" >
<img class="left" src="http://marcyoung.us/images/cabinet4.jpg" title="cabinet 4" >
<img class="left" src="http://marcyoung.us/images/cabinet5.jpg" title="cabinet 5" >
<img class="left" src="http://marcyoung.us/images/cabinet6.jpg" title="cabinet 6" >
<img class="left" src="http://marcyoung.us/images/cabinet7.jpg" title="cabinet 7" >
<img class="left" src="http://marcyoung.us/images/cabinet8.jpg" title="cabinet 8" >
<img class="left" src="http://marcyoung.us/images/cabinet9.jpg" title="cabinet 9" >
<img class="left" src="http://marcyoung.us/images/cabinet10.jpg" title="cabinet 10" >
<img class="left" src="http://marcyoung.us/images/cabinet11.jpg" title="cabinet 11" ></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Azure, Github, and a Corporate Proxy]]></title>
    <link href="http://marcyoung.us/post/azure-github-proxy"/>
    <updated>2015-05-18T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/aspnet-github</id>
    <content type="html"><![CDATA[<p>Recently I started playing around with Azure and deploying an ASP.NET MVC site via its Github linkage. I had some strange issues.<!-- more --></p>

<h1>Problem 1: I am a masochist</h1>

<p>Under the strange suspicion that I had no idea how to actually build NuGet packages and deploy an ASP.NET site via CI/CD I decided to take on the masochistic task upon myself.
If you <a href="https://github.com/myoung34/HelloWorldASP">take a look at my very basic MVC site</a>, you won&rsquo;t see much of interest. None actually, I&rsquo;m not sure why you possibly clicked that link.</p>

<p>It&rsquo;s a basic MVC app using a terrible NuGet package I&rsquo;ve been deploying that adds some string extension methods. If you run that in Visual Studio, all is well.</p>

<h1>Problem 2: The work proxy</h1>

<p>I tried to publish it to Azure using <a href="http://blogs.technet.com/b/cbernier/archive/2013/09/24/deploy-your-web-application-to-windows-azure-from-with-visual-studio.aspx">the publish feature from VS2013 into Azure</a> but immediately ran into a &lsquo;me&rsquo; problem.</p>

<p>You see, I was deploying from my work PC, which is absolutely blocked from doing anything. All of the traffic from my work PC <strong>must</strong> be published through a web proxy on-site.</p>

<p>This is fine for things like Chrome, which pick those settings up automatically. For cygwin (see problem 1) there are a lot of steps to take.</p>

<ul>
<li>wget/Vagrant: I had to export <code>http_proxy</code>, <code>https_proxy</code>, and <code>ftp_proxy</code> (after pulling down the proxy PAC and finding which proxy address to use).</li>
<li>cURL: I had to write a wrapper <code>/usr/local/bin/curl</code>(higher in the PATH) that basically said <code>/usr/bin/curl --proxy 'http://proxyaddress:80' "$@"</code>.</li>
<li>subversion: I had to add <code>http-proxy-host = proxyaddress</code> into <code>~/.subversion/servers</code> in the <code>[global]</code> section.</li>
<li>git: OMG GIT. So here&rsquo;s the thing. git behind a corporate firewall is hard. It can&rsquo;t resolve through DNS and it can&rsquo;t do anything it needs to do.

<ul>
<li>First I installed <a href="http://ntlmaps.sourceforge.net/">ntmlaps</a> into <code>~/software/ntlmaps</code></li>
<li>Next I set my <code>~.bash_profile</code> to start up a command in screen if it hasn&rsquo;t already to start ntlmaps.

<ul>
<li><code>[[ -n $(screen -ls | grep -E 'git-proxy.\*\((A|De)tached\)$') ]] || screen -d -S git-proxy -m python ~/software/ntlmaps/main.py</code></li>
</ul>
</li>
<li>Next I set git to use this proxy: <code>for i in http https; do git config --global $i.proxy http://localhost:5865</code></li>
</ul>
</li>
</ul>


<h1>Problem 3: Visual Studio and Azure Deploy</h1>

<p><a href="http://blog.kloud.com.au/2014/11/13/publish-to-a-new-azure-website-from-behind-a-proxy/">Visual studio cannot deploy to Azure behind a PAC proxy</a>.</p>

<p>Sites like this one claim you can make changes to the VS2013 executable config but I had zero luck.</p>

<p>So little luck in fact that it just plain failed with an unconnectable error.</p>

<p>From then I said nevermind and decided to just link my Azure app to my github repo using the web UI. All went great and it immediately deployed however when I browsed to my website I was <a href="http://www.dotnetthoughts.net/azure-system-methodaccessexception-attempt-by-security-transparent-method/">greeted with this error.</a>.</p>

<p>All of the blog posts and stack overflow questions say to install the WebHelpers NuGet package via <code>Install-Package -Id  Microsoft.AspNet.WebHelpers</code>, but that didn&rsquo;t solve it. It redeployed and had the same error.</p>

<p>The posts also say to just select the <code>Remove additional files at destination</code> checkbox on Visual Studio deploy. Well that&rsquo;s useless because I cannot deploy via visual studio. After fighting long and hard and redeploying via Github repeatedly, I found the answer.</p>

<h1>Answer: Select the <code>Remove additional files at destination</code> no matter what.</h1>

<p>Yup. I changed to the guest network, selected the checkbox, published successfully and all went well. My app was now live.
I then pushed multiple changes/rebases into the github repo, and it&rsquo;s been working fine since.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Well, I wrote a book]]></title>
    <link href="http://marcyoung.us/post/book"/>
    <updated>2015-04-08T00:00:00-05:00</updated>
    <id>http://marcyoung.us/post/book</id>
    <content type="html"><![CDATA[<p>It&rsquo;s been quite a while since my last post, but I promise I have somewhat of a decent reason. I wrote a book on AWS design patterns!<!-- more --></p>

<p>About 4 months ago I was approached about writing a book on UDOO. I turned it down as I didn&rsquo;t feel like I would have enough content to write anything meaningful on it other than I have no idea what the name means. I then stayed on their list and reviewed a book on <a href="https://www.packtpub.com/virtualization-and-cloud/getting-started-red-hat-enterprise-virtualization">RHEV</a> (or the downstream oVirt) as well as a book on <a href="https://www.packtpub.com/networking-and-servers/learning-puppet-security">puppet security</a>.</p>

<p>After doing these reviews I figured &ldquo;why not&rdquo; and asked if there were any topics I could work on. Long story short I wrote <a href="https://www.packtpub.com/web-development/implementing-cloud-design-patterns-aws">a book on implementing design patterns at AWS</a>.</p>

<p>Writing the book was fairly straight-forward and I didn&rsquo;t have too many issues. Basically I borrowed a lot of concepts from the very outdated topics from the Ninja Of Three pages (and by borrowed I mean don&rsquo;t go there) and adapted them for use, updated them to reflect changes at AWS (which get updated so much my book is already out of date before publication - hawt), and gave in depth information on what these patterns mean to DevOps, developers, and customers.</p>

<p>If you&rsquo;re reading this and <strong>really</strong> want to help a newbie out, please purchase it as 100% of the proceeds go to student loans and nice bourbon (order not guaranteed).</p>

<p>The book is pending a last review before publication right now. I submitted a few images for the cover photo that have not been selected by the publisher yet but I give you my top two rejected images.</p>

<p><img src="http://marcyoung.us/images/book.jpg"/><img src="http://marcyoung.us/images/book-alt.jpg"/></p>

<p>Update 4/29/2015: <a href="http://amzn.to/1zrxpZx">It&rsquo;s back up for sale at amazon</a></p>
]]></content>
  </entry>
  
</feed>
