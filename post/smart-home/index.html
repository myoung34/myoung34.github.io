
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My Secure Smart Home - Marcus Young</title>
  <meta name="author" content="Marcus Young">

  
  <meta name="description" content="A quick write up of how I have IoT devices that I consider secure (at the cost of my sanity). I&rsquo;ve spent the last year figuring out what I want &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://marcyoung.us/post/smart-home">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/button.css" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Marcus Young" type="application/atom+xml">
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-29328388-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText"></div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">Marcus Young</a></h1>
  
    <h2>Software. Microcontrollers. Beer.</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:marcyoung.us" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://github.com/myoung34">Github</a></li>
  <li><a href="https://www.linkedin.com/pub/marcus-young/2a/69b/a63">LinkedIn</a></li>
  <li><a href="https://www.dropbox.com/s/7sbbbqe9d7sp3zh/Resume-Marcus.Young.doc?dl=0">Resume</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">My Secure Smart Home</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2020-03-31T00:00:00+00:00" pubdate data-updated="true"></time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>A quick write up of how I have IoT devices that I consider secure (at the cost of my sanity).  <!-- more --></p>

<p>I&rsquo;ve spent the last year figuring out what I want to control &ldquo;things&rdquo; in my house. And after wasting a bunch of time and money I finally have a set up I like.</p>

<h2>The Network</h2>

<p><del>I don&rsquo;t have any crazy networking gear, just a <a href="https://www.amazon.com/R7000-100PAS-Nighthawk-Parental-Controls-Compatible/dp/B00F0DD0I6">Netgear r7000</a> running <a href="https://www.myopenrouter.com/kong-downloads">Kong</a></del></p>

<p>I now have a very different set up.
<img src="/images/router.jpg"></p>

<p>Configuring this for my setup is painful, but:</p>

<ul>
<li>Main Network (wired + wireless N+AG): I whitelist all my devices by Mac Address and assign static IP&rsquo;s to things.</li>
<li>Guest Network: no whitelisting, can only reach the internet</li>
<li>Black Hole Sun: My black hole wifi for things I don&rsquo;t trust like my TV. I know for a fact that the TV tries to send data over open wifi&rsquo;s so my hope here is to prevent that by giving it valid networking that just cant talk to anything at all.</li>
<li>Server network: My main server stuff is here. A nomad cluster across an i7 server and a bunch of pi&rsquo;s, also a <a href="https://www.synology.com/en-us/products/DS918+">DS918+</a>. DNS is here because I use Consul with dnsmasq. Some smart stuff lives here like my <a href="https://www.ecobee.com/">ecobee</a>.</li>
<li>IoT Network: the real meat. This is nearly the same as the black hole one except it  can talk to the Server Network for C&amp;C (esphome)</li>
</ul>


<h2>The Software</h2>

<p>First I played with <a href="https://tasmota.github.io">tasmota</a> and the devices would randomly require me to set them up again.</p>

<p>Have you ever bought a device that turns on, sets up an AP for you to connect to then configure it? Thats a lot like Tasmota.</p>

<p>The problem is that in just a few days I had to set up the same devices multiple times. So I&rsquo;d go to do something, it wouldnt exist in homeassistant, and Id see a few <code>tasmota-#####</code> AP&rsquo;s I had to set up again.</p>

<p>I solved this by pulling the source code down, modify the configs (which took a lot of figuring out for the settings), compile it, flash it. Per device.</p>

<p>Then I had to upload the actual config for pins/buttons/etc. I hated this. Every second of it.</p>

<p>After playing around with <strong>way</strong> too many things, I finally landed on <a href="https://esphome.io/">esphome</a>.</p>

<p>Esphome is amazing. It has over-the-air updates, it automatically compiles based on some yaml and uploads it!
If it cant upload it (like the initial flash) I would simply set up the yaml, compile it, SCP it locally and flash it with <a href="https://github.com/espressif/esptool">https://github.com/espressif/esptool</a>. If this worked, it would now support OTA updates.</p>

<p>Because its a bunch of yaml I can source control it too!</p>

<p>It uses passwords for both API integrations (home-assistant) and for OTA updates (same or different password) which makes me feel good.</p>

<p>Also: the server runs as a container, so its running on my Server network on nomad. I can simply go to <a href="http://esphome.service.consul">http://esphome.service.consul</a> and click &ldquo;Upload&rdquo; to update my IoT.</p>

<p><img src="/images/esphome.png"></p>

<p>As for the controlling the devices I chose home-assistant. It has great support for ESPHome.</p>

<p><img src="/images/hass.png"></p>

<h2>The Devices</h2>

<p>This is what you&rsquo;re really here for. Everything is ESP based for esphome.</p>

<p>I flashed almost all of these with an <a href="https://www.amazon.com/HiLetgo-FT232RL-Converter-Adapter-Breakout/dp/B00IJXZQ7C">ftdi serial adapter</a> and <a href="https://github.com/espressif/esptool">esptool.py</a> similar to</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>firmware="something.bin"
</span><span class='line'>port="/dev/cu.usbserial-00000000"
</span><span class='line'>esptool.py --port ${port} --baud 115200 erase_flash
</span><span class='line'>esptool.py --port ${port} --baud 115200 write_flash 0x0 ${firmware}</span></code></pre></td></tr></table></div></figure>


<h3>Garage Door Opener</h3>

<p>This one took some learning to get right.
Its a <a href="https://www.amazon.com/HiLetgo-Internet-Development-Wireless-Micropython/dp/B081CSJV2V">nodemcu ESP8266</a> hooked up to a 12v relay shimmed to the garage door trigger. Triggering GPIO16 triggers the relay.
Attached to GPIO5 is a reed switch on the garage door track that is open or closed. The reed switch is a magnetic based switch. When a magnet is near it, it  breaks the switch (open) meaning the garage door is closed. I wired it this way so that the only way the door can be considered &ldquo;closed&rdquo; is that the magnet has broken the sensor. No power, messed up sensor, manually opened (without using the garage door chain) etc would all be considered an open door. I chose this because I&rsquo;d rather be safe than sorry and the door being closed is not an assumption but a fact.</p>

<p><img src="/images/esp-garage1.jpg">
<img src="/images/esp-garage2.jpg">
<img src="/images/esp-garage3.jpg">
<img src="/images/esp-garage4.jpg"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>esphome:
</span><span class='line'>  name: garage_switch
</span><span class='line'>  platform: ESP8266
</span><span class='line'>  board: esp01_1m
</span><span class='line'>wifi:
</span><span class='line'>  ssid: !secret wifi_name
</span><span class='line'>  password: !secret wifi_pass
</span><span class='line'>  domain: !secret wifi_domain
</span><span class='line'>logger:
</span><span class='line'>api:
</span><span class='line'>  password: !secret api_password
</span><span class='line'>ota:
</span><span class='line'>  password: !secret ota_password
</span><span class='line'>binary_sensor:
</span><span class='line'>  - platform: status
</span><span class='line'>    name: "garage"
</span><span class='line'>  - platform: gpio
</span><span class='line'>    pin:
</span><span class='line'>      number: 16
</span><span class='line'>      inverted: False
</span><span class='line'>      mode: INPUT_PULLUP
</span><span class='line'>    name: "door"
</span><span class='line'>    device_class: door
</span><span class='line'>    filters:
</span><span class='line'>      - delayed_off: 10ms
</span><span class='line'>      - delayed_on: 10ms
</span><span class='line'>switch:
</span><span class='line'>  - platform: gpio
</span><span class='line'>    name: "garage"
</span><span class='line'>    pin: 5</span></code></pre></td></tr></table></div></figure>


<h3>Sprinklers</h3>

<p>This one is in progress. It works but I haven&rsquo;t finished the housing (needs to be gasket based and ABS).</p>

<p>This is based on a <a href="https://www.amazon.com/HiLetgo-Development-ESP8285-Wireless-Internet/dp/B07BK435ZW">wemos d1 mini</a> and is essentially 2 <a href="https://www.amazon.com/gp/product/B010LT2GPG">12v solenoid valves</a> on GPIO16 and GPIO14. the 12V is controlled based on circuitry through diodes and TIP120 fed from a 12V source (dropped to 5v via a LM7805 to the d1 mini).</p>

<p><img src="/images/solenoid_circuit.png">
<img src="/images/esp-sprinkler1.jpg">
<img src="/images/esp-sprinkler2.jpg"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>esphome:
</span><span class='line'>  name: sprinklers
</span><span class='line'>  platform: ESP8266
</span><span class='line'>  board: esp01_1m
</span><span class='line'>wifi:
</span><span class='line'>  ssid: !secret wifi_name
</span><span class='line'>  password: !secret wifi_pass
</span><span class='line'>  domain: !secret wifi_domain
</span><span class='line'>logger:
</span><span class='line'>api:
</span><span class='line'>  password: !secret api_password
</span><span class='line'>ota:
</span><span class='line'>  password: !secret ota_password
</span><span class='line'>switch:
</span><span class='line'>  - platform: gpio
</span><span class='line'>    name: "sprinkler1"
</span><span class='line'>    pin: 16
</span><span class='line'>    inverted: no
</span><span class='line'>  - platform: gpio
</span><span class='line'>    name: "sprinkler2"
</span><span class='line'>    pin: 14
</span><span class='line'>    inverted: no</span></code></pre></td></tr></table></div></figure>


<h3>Camera</h3>

<p>This one is still a bit in progress. My end goal is to take snapshots on an interval and push them to s3 so that I can play around with machine learning, but right now it lets me view it in hass (no recording as of now).</p>

<p>I chose the <a href="https://www.amazon.com/gp/product/B07RXPHYNM">esp32-cam</a> because it&rsquo;s very cheap. That&rsquo;s all, and it supports esphome.
The housing I 3d printed <a href="https://www.thingiverse.com/thing:3652452">from here</a></p>

<p>Note: This was a bit annoying to set up the first time. You can&rsquo;t &ldquo;just flash it&rdquo;, you need to set up <a href="https://github.com/pellepl/spiffs">spiffs</a> correctly. Which looked like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>firmware="something.bin"
</span><span class='line'>port="/dev/cu.usbserial-00000000"
</span><span class='line'># minimal spiffs:
</span><span class='line'>esptool.py --port ${port} --baud 921600 --chip esp32 erase_flash
</span><span class='line'>esptool.py --chip esp32 --port ${port} --baud 921600 --before default_reset --after hard_reset write_flash -z --flash_mode dio --flash_freq 80m --flash_size detect 0x1000 /Users/myoung/Library/Arduino15/packages/esp32/hardware/esp32/1.0.4/tools/sdk/bin/bootloader_qio_80m.bin 0x10000 ${firmware}</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/esp32-cam.jpg"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>esphome:
</span><span class='line'>  name: frontdoor_cam
</span><span class='line'>  platform: ESP32
</span><span class='line'>  board: esp32dev
</span><span class='line'>wifi:
</span><span class='line'>  ssid: !secret wifi_name
</span><span class='line'>  password: !secret wifi_pass
</span><span class='line'>  domain: !secret wifi_domain
</span><span class='line'>logger:
</span><span class='line'>api:
</span><span class='line'>  password: !secret api_password
</span><span class='line'>ota:
</span><span class='line'>  password: !secret ota_password
</span><span class='line'>esp32_camera:
</span><span class='line'>  name: frontdoor_cam
</span><span class='line'>  external_clock:
</span><span class='line'>    pin: GPIO0
</span><span class='line'>    frequency: 20MHz
</span><span class='line'>  i2c_pins:
</span><span class='line'>    sda: GPIO26
</span><span class='line'>    scl: GPIO27
</span><span class='line'>  data_pins: [GPIO5, GPIO18, GPIO19, GPIO21, GPIO36, GPIO39, GPIO34, GPIO35]
</span><span class='line'>  vsync_pin: GPIO25
</span><span class='line'>  href_pin: GPIO23
</span><span class='line'>  pixel_clock_pin: GPIO22
</span><span class='line'>  power_down_pin: GPIO32
</span><span class='line'>  resolution: 1600x1200
</span><span class='line'>  max_framerate: 30 fps
</span><span class='line'>  jpeg_quality: 25</span></code></pre></td></tr></table></div></figure>


<h3>LED Strips</h3>

<p>In the kids room I have some <a href="https://www.amazon.com/Twinkle-Star-Waterproof-Extendable-Decoration/dp/B07FSLWPRB">star lights</a>, and on our Pergola I have some <a href="https://www.amazon.com/Flexible-Waterproof-Christmas-Kitchen-Daylight/dp/B00HSF66JO">waterproof LED lights</a> all controlled with:</p>

<p><a href="https://www.amazon.com/Nexlux-Wireless-Controller-Compatible-Included/dp/B07116SX41">This magic home smart controller</a> . I chose this because its ESP8266 based and flashable!</p>

<p><img src="/images/magichome.jpg"></p>

<p>Wiring that up to the FTDI I flashed this yaml:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>esphome:
</span><span class='line'>  name: liam_room_starlights
</span><span class='line'>  platform: ESP8266
</span><span class='line'>  board: esp01_1m
</span><span class='line'>wifi:
</span><span class='line'>  ssid: !secret wifi_name
</span><span class='line'>  password: !secret wifi_pass
</span><span class='line'>  domain: !secret wifi_domain
</span><span class='line'>logger:
</span><span class='line'>api:
</span><span class='line'>  password: !secret api_password
</span><span class='line'>ota:
</span><span class='line'>  password: !secret ota_password
</span><span class='line'>light:
</span><span class='line'>  - platform: rgbww
</span><span class='line'>    name: "Liam Starlight"
</span><span class='line'>    red: output_component1
</span><span class='line'>    green: output_component2
</span><span class='line'>    blue: output_component3
</span><span class='line'>    cold_white: output_component4
</span><span class='line'>    cold_white_color_temperature: 6536 K
</span><span class='line'>    warm_white: output_component5
</span><span class='line'>    warm_white_color_temperature: 2000 K
</span><span class='line'>
</span><span class='line'>output:
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: output_component1
</span><span class='line'>    pin: 5
</span><span class='line'>
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: output_component2
</span><span class='line'>    pin: 12
</span><span class='line'>
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: output_component3
</span><span class='line'>    pin: 13
</span><span class='line'>
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: output_component4
</span><span class='line'>    pin: 15
</span><span class='line'>
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: output_component5
</span><span class='line'>    pin: 16</span></code></pre></td></tr></table></div></figure>


<h3>Light Bulbs</h3>

<p>For the bulbs I chose <a href="https://www.amazon.com/gp/product/B07RZ8QMG3">globe brand</a> because theyre also ESP8266 based.</p>

<p>For 2 of 3 of these I had success with <a href="https://github.com/ct-Open-Source/tuya-convert">tuya-convert</a> which was pleasant.
Basically I built my .bin from the yaml below, replaced tasmota.bin in that dir with it because I&rsquo;m sneaky, ran tuya-convert, flipped the light off/on 3 times and it flashed.</p>

<p>For 2 of them (1 I broke), I had to get down and dirty. I basically tore it apart and followed <a href="https://github.com/arendst/Tasmota/wiki/Mirabella-Genio-Bulb">this guide</a>. Temporarily soldering and removing all the heat safe gunk is not fun. But 1 flashed. 1&hellip;.caught fire&hellip;.</p>

<p><img src="/images/bulb-fire.jpg"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>esphome:
</span><span class='line'>  name: driveway_light
</span><span class='line'>  platform: ESP8266
</span><span class='line'>  board: esp01_1m
</span><span class='line'>wifi:
</span><span class='line'>  ssid: !secret wifi_name
</span><span class='line'>  password: !secret wifi_pass
</span><span class='line'>  domain: !secret wifi_domain
</span><span class='line'>logger:
</span><span class='line'>api:
</span><span class='line'>  password: !secret api_password
</span><span class='line'>ota:
</span><span class='line'>  password: !secret ota_password
</span><span class='line'>output:
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: output_green
</span><span class='line'>    pin: GPIO12
</span><span class='line'>    max_power: 0.7
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: output_red
</span><span class='line'>    pin: GPIO4
</span><span class='line'>    max_power: 0.7
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: output_blue
</span><span class='line'>    pin: GPIO14
</span><span class='line'>    max_power: 0.7
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: output_wwhite
</span><span class='line'>    pin: GPIO13
</span><span class='line'>    max_power: 0.65
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: output_cwhite
</span><span class='line'>    pin: GPIO5
</span><span class='line'>    max_power: 0.65
</span><span class='line'>light:
</span><span class='line'>  - platform: rgbww
</span><span class='line'>    name: "driveway_light"
</span><span class='line'>    id: light_rgb
</span><span class='line'>    red: output_red
</span><span class='line'>    green: output_green
</span><span class='line'>    blue: output_blue
</span><span class='line'>    cold_white: output_cwhite
</span><span class='line'>    warm_white: output_wwhite
</span><span class='line'>    cold_white_color_temperature: 5000 K
</span><span class='line'>    warm_white_color_temperature: 2000 K
</span><span class='line'>    effects:
</span><span class='line'>      - strobe:
</span><span class='line'>      - flicker:
</span><span class='line'>      - random:
</span><span class='line'>    restore_mode: ALWAYS_ON</span></code></pre></td></tr></table></div></figure>


<h3>Smart Plugs</h3>

<p>These come in handy for seasonal stuff like xmas lights, etc. But especially for my 3d printer as an emergency safe-measure (forget to turn off etc)</p>

<p>I chose the <a href="https://www.amazon.com/Sonoff-Compatible-Assistant-Supporting-Required/dp/B07YXVWC3Y">Sonoff S31</a>.</p>

<p><img src="/images/s31_1.jpg">
<img src="/images/s31_2.jpg"></p>

<p>Easy to take apart, a bit annoying to flash (involves temporarily soldering), but work amazingly.</p>

<p>The yaml makes sure that its on by default and that the power button is a hard toggle for the power for manual control. Blue light indicates wifi, red indicates on/off for the relay.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>esphome:
</span><span class='line'>  name: plug1
</span><span class='line'>  platform: ESP8266
</span><span class='line'>  board: esp01_1m
</span><span class='line'>wifi:
</span><span class='line'>  ssid: !secret wifi_name
</span><span class='line'>  password: !secret wifi_pass
</span><span class='line'>  domain: !secret wifi_domain
</span><span class='line'>logger:
</span><span class='line'>api:
</span><span class='line'>  password: !secret api_password
</span><span class='line'>ota:
</span><span class='line'>  password: !secret ota_password
</span><span class='line'>binary_sensor:
</span><span class='line'>  - platform: gpio
</span><span class='line'>    pin:
</span><span class='line'>      number: GPIO0
</span><span class='line'>      mode: INPUT_PULLUP
</span><span class='line'>      inverted: True
</span><span class='line'>    name: "Button"
</span><span class='line'>    on_press:
</span><span class='line'>      - switch.toggle: fakebutton
</span><span class='line'>  - platform: template
</span><span class='line'>    name: "Running"
</span><span class='line'>    filters:
</span><span class='line'>      - delayed_off: 15s
</span><span class='line'>    lambda: |-
</span><span class='line'>      if (isnan(id(power).state)) {
</span><span class='line'>        return {};
</span><span class='line'>      } else if (id(power).state &gt; 4) {
</span><span class='line'>        // Running
</span><span class='line'>        return true;
</span><span class='line'>      } else {
</span><span class='line'>        // Not running
</span><span class='line'>        return false;
</span><span class='line'>      }
</span><span class='line'>switch:
</span><span class='line'>  - platform: template
</span><span class='line'>    name: "POW Relay"
</span><span class='line'>    optimistic: true
</span><span class='line'>    id: fakebutton
</span><span class='line'>    turn_on_action:
</span><span class='line'>    - switch.turn_on: relay
</span><span class='line'>    - light.turn_on: led
</span><span class='line'>    turn_off_action:
</span><span class='line'>    - switch.turn_off: relay
</span><span class='line'>    - light.turn_off: led
</span><span class='line'>  - platform: gpio
</span><span class='line'>    id: relay
</span><span class='line'>    pin: GPIO12
</span><span class='line'>    restore_mode: ALWAYS_ON
</span><span class='line'>output:
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: pow_blue_led
</span><span class='line'>    pin:
</span><span class='line'>      number: GPIO13
</span><span class='line'>      inverted: True
</span><span class='line'>
</span><span class='line'>light:
</span><span class='line'>  - platform: monochromatic
</span><span class='line'>    name: "Blue LED"
</span><span class='line'>    output: pow_blue_led
</span><span class='line'>    id: led
</span><span class='line'>    restore_mode: ALWAYS_ON
</span><span class='line'>
</span><span class='line'>sensor:
</span><span class='line'>  - platform: wifi_signal
</span><span class='line'>    name: "WiFi Signal"
</span><span class='line'>    update_interval: 60s
</span><span class='line'>  - platform: uptime
</span><span class='line'>    name: "Uptime"
</span><span class='line'>  - platform: cse7766
</span><span class='line'>    update_interval: 2s
</span><span class='line'>    current:
</span><span class='line'>      name: "Current"
</span><span class='line'>    voltage:
</span><span class='line'>      name: "Voltage"
</span><span class='line'>    power:
</span><span class='line'>      name: "POW Power"
</span><span class='line'>      id: power
</span><span class='line'>      on_value_range:
</span><span class='line'>        - above: 4.0
</span><span class='line'>          then:
</span><span class='line'>            - light.turn_on: led
</span><span class='line'>        - below: 3.0
</span><span class='line'>          then:
</span><span class='line'>            - light.turn_off: led
</span><span class='line'>text_sensor:
</span><span class='line'>  - platform: version
</span><span class='line'>    name: "ESPHome Version"</span></code></pre></td></tr></table></div></figure>


<h3>Smart Switch</h3>

<p>I kept blowing my outdoor smart bulb, I&rsquo;m guessing the voltage or current is too volatile?</p>

<p>I chose the <a href="https://www.amazon.com/gp/product/B07R7PCCT9">TreatLife single pole</a>.</p>

<p><img src="/images/ss01s.png"></p>

<p>This yaml lets the LED indicator (GPIO4) toggle with the virtual button (GPIO13) and the physical button (GPIO12)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>esphome:
</span><span class='line'>  name: front_porch_switch
</span><span class='line'>  platform: ESP8266
</span><span class='line'>  board: esp01_1m
</span><span class='line'>
</span><span class='line'>wifi:
</span><span class='line'>  ssid: !secret wifi_ssid
</span><span class='line'>  password: !secret wifi_password
</span><span class='line'>  domain: !secret wifi_domain
</span><span class='line'>
</span><span class='line'>logger:
</span><span class='line'>  level: VERBOSE
</span><span class='line'>  baud_rate: 0
</span><span class='line'>
</span><span class='line'>api:
</span><span class='line'>  password: !secret api_password
</span><span class='line'>
</span><span class='line'>ota:
</span><span class='line'>  password: !secret ota_password
</span><span class='line'>
</span><span class='line'>switch:
</span><span class='line'>  - platform: gpio
</span><span class='line'>    id: "relay"
</span><span class='line'>    name: "light"
</span><span class='line'>    pin: 12
</span><span class='line'>
</span><span class='line'>output:
</span><span class='line'>  - platform: esp8266_pwm
</span><span class='line'>    id: status_led
</span><span class='line'>    pin:
</span><span class='line'>      number: GPIO4
</span><span class='line'>      inverted: True
</span><span class='line'>
</span><span class='line'>binary_sensor:
</span><span class='line'>  - platform: gpio
</span><span class='line'>    name: "button"
</span><span class='line'>    pin:
</span><span class='line'>      number: 13
</span><span class='line'>      inverted: True
</span><span class='line'>    on_press:
</span><span class='line'>      - switch.toggle: relay</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">myoung</span></span>

      








  


<time datetime="2020-03-31T00:00:00+00:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/conference/'>conference</a>, <a class='category' href='/blog/categories/hacking/'>hacking</a>, <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/pytn/'>pytn</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/post/homebrew-hacking" title="Previous Post: Homebrew Hacking">&laquo; Homebrew Hacking</a>
      
      
        <a class="basic-alignment right articlenav" href="/post/atlantis-opa" title="Next Post: Terraform and Open Policy Agent with Atlantis">Terraform and Open Policy Agent with Atlantis &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/post/zuckerpunch">Zuckerpunch - Abusing Self Hosted Github Runners at Facebook</a>
      </li>
    
      <li class="post">
        <a href="/post/pinball">Building a Digital Pinball</a>
      </li>
    
      <li class="post">
        <a href="/post/plaato_keg_esphome">Making My Own Plaato Keg Firmware</a>
      </li>
    
      <li class="post">
        <a href="/post/arcade_rebuilds">Some Arcade Rebuilds</a>
      </li>
    
      <li class="post">
        <a href="/post/kubecon_2021">Kubecon - AWS Organizations and Cloud-Custodian</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'myoung34',
            count: 0,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/106595646200297464671?rel=author">
      <img src="https://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Marcus Young -
  <span class="credit">Powered by <a href="https://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'marcyoung';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://marcyoung.us/post/smart-home';
        var disqus_url = 'https://marcyoung.us/post/smart-home';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>







</body>
</html>
