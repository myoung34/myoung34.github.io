
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Creating an MVC Blog with Node.js and MongoDB - Marcus Young</title>
  <meta name="author" content="Marcus Young">

  
  <meta name="description" content="This is going to be my first big tutorial. This is a simple tutorial to show how to build the worlds most basic blog with comment system in Node.js &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://myoung34.github.io/post/creating-an-mvc-blog-with-node-js-and-mongodb/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Marcus Young" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-29328388-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText"></div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">Marcus Young</a></h1>
  
    <h2>Software. Microcontrollers. Beer.</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:myoung34.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://github.com/myoung34">Github</a></li>
  <li><a href="http://plus.google.com/106595646200297464671">Google+</a></li>
  <li><a href="http://www.linkedin.com/pub/marcus-young/2a/69b/a63">LinkedIn</a></li>
  <li><a href="https://www.dropbox.com/s/3dnv34v27xrnawb/Resume-Marcus.Young%20-%20Public.doc">Resume</a></li>
  <li><a href="http://vizualize.me/4PXMEv1a2i#.Ub1B1JyIK64">Vizualize.me Resume</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Creating an MVC Blog With Node.js and MongoDB</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-04-25T00:00:00-05:00" pubdate data-updated="true"></time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>This is going to be my first big tutorial. This is a simple tutorial to show how to build the worlds most basic blog with comment system in Node.js with Express for the MVC Routing, MongoDB as the storage engine, and Jade as the html shorthand. <!--more--></p>

<p>I&#8217;m going to assume you know how to install the base packages for Node.js, npm (node package manager), and mongodb. First, let&#8217;s set up the database to hold some articles. The mongo collection will be a basic object with an id, article_title, and article_body:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[myoung@F00 tutorial]$ mongo tutorial
</span><span class='line'>MongoDB shell version: 2.0.2
</span><span class='line'>connecting to: tutorial
</span><span class='line'>&gt; db.articles.remove()
</span><span class='line'>&gt; db.articles.insert({"article_title": "Article 1","article_body": "This would be the data from &lt;strong&gt;Article 1&lt;/strong&gt;","article_date": new Date()});
</span><span class='line'>&gt; db.articles.insert({"article_title": "Article 2","article_body": "This would be the data from &lt;strong&gt;Article 2&lt;/strong&gt;
</span><span class='line'>I think I'll put some more data in this one =)","article_date": new Date()});</span></code></pre></td></tr></table></div></figure>


<p>Now, let&#8217;s get the modules installed via npm.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[myoung@F00 ~]$ mkdir tutorial
</span><span class='line'>[myoung@F00 ~]$ cd tutorial
</span><span class='line'>[myoung@F00 tutorial]$ npm install connect # the middleware module for the model
</span><span class='line'>[myoung@F00 tutorial]$ npm install express # the module to set up 'route' or controllers
</span><span class='line'>[myoung@F00 tutorial]$ npm install jade # the module to set up shorthand html, or views</span></code></pre></td></tr></table></div></figure>


<p>Next, the actual node app is needed. It&#8217;s a basic setup that loads the installed modules, listens on port 9095, and responds to any GET on &#8216;/&#8217; with &#8216;Hello from node.js!&#8217;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var express = require('express')
</span><span class='line'>var app = module.exports = express.createServer();
</span><span class='line'> 
</span><span class='line'>// Configuration
</span><span class='line'>app.configure(function(){
</span><span class='line'>  app.set('views', __dirname + '/views');
</span><span class='line'>  app.set('view engine', 'jade');
</span><span class='line'>  app.use(express.static(__dirname + '/public'));
</span><span class='line'>  app.set('view options', { layout: false });
</span><span class='line'>  app.use(app.router);
</span><span class='line'>});
</span><span class='line'> 
</span><span class='line'>app.configure('development', function(){
</span><span class='line'>  app.use(express.errorHandler({ dumpExceptions: true, showStack: true }));
</span><span class='line'>});
</span><span class='line'> 
</span><span class='line'>app.configure('production', function(){
</span><span class='line'>  app.use(express.errorHandler());
</span><span class='line'>});
</span><span class='line'> 
</span><span class='line'>// Routes
</span><span class='line'>app.get('/',function(req,res) {
</span><span class='line'>  res.writeHead(200);
</span><span class='line'>  res.end("Hello from node.js!");
</span><span class='line'>});
</span><span class='line'> 
</span><span class='line'>app.listen(9095);</span></code></pre></td></tr></table></div></figure>


<p>If you run this, you&#8217;ll see that we have the worlds most basic server, let&#8217;s make it a little more advanced. This next version will set up a route that sends GET&#8217;s on &#8216;/&#8217; to &#8216;views/index.jade&#8217;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app.get('/',function(req,res) {
</span><span class='line'>  res.render('index', {});
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-//new file: views/index.jade
</span><span class='line'>!!!
</span><span class='line'>html
</span><span class='line'>  head
</span><span class='line'>    title MVC Webpage
</span><span class='line'>  body
</span><span class='line'>    | This is the main layout</span></code></pre></td></tr></table></div></figure>


<p>This is all fine and dandy, but it&#8217;s pretty basic. If we want to make any real web app, we have to minimize code reuse. The great thing about jade is its ability to extend other files.So let&#8217;s make a base layout.jade that holds all the html(in your final blog you&#8217;d want it to load the css, and actually set up the page). Extending in Jade works by creating a file, styling it with css, loading whatever jQuery modules or anything you&#8217;d want to display, and setting &#8216;blocks&#8217;. Blocks will be overridden by child pages, so you&#8217;d want it to be where your content is, or data that will change from view to view. A side note, which you&#8217;ll notice in later snippets, is that you can put inline JavaScript in the jade file, and it can determine what is rendered</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-//file is layout.jade...the 'parent' view
</span><span class='line'>!!!
</span><span class='line'>html
</span><span class='line'>  head
</span><span class='line'>    title MVC Webpage
</span><span class='line'>  body
</span><span class='line'>    block content
</span><span class='line'>      | This is the main layout
</span><span class='line'> 
</span><span class='line'>-//index.jade
</span><span class='line'>extends layout
</span><span class='line'>-//now index is a 'child' of layout
</span><span class='line'>block content
</span><span class='line'>  | This was overridden by the index =)</span></code></pre></td></tr></table></div></figure>


<p>Now that we&#8217;ve got a successful, notably basic, MVC framework set, let&#8217;s make it Mongo compatible so we can display some stuff. I tested a few Mongo modules, but enjoyed this one the most. It plays more like the CLI and has minimal overhead</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[myoung@F00 tutorial]$ npm install mongodb</span></code></pre></td></tr></table></div></figure>


<p>Now the app.js has to be modified to make the connection, and on response to &#8216;/&#8217;, grab the collection as an array, and pass it to the page as a variable.The index.jade also has to be modified to check for the array passed in, and loop through it displaying the title and body</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var mongodb = require('mongodb')
</span><span class='line'>  , Db = mongodb.Db
</span><span class='line'>  , Server = mongodb.Server
</span><span class='line'>  , db = new Db('tutorial', new Server('localhost', 27017, {auto_reconnect: true, native_parser: true}), {})
</span><span class='line'>var express = require('express')
</span><span class='line'>var app = module.exports = express.createServer();
</span><span class='line'> 
</span><span class='line'>// Configuration
</span><span class='line'>app.configure(function(){
</span><span class='line'>  app.set('views', __dirname + '/views');
</span><span class='line'>  app.set('view engine', 'jade');
</span><span class='line'>  app.use(express.static(__dirname + '/public'));
</span><span class='line'>  app.set('view options', { layout: false });
</span><span class='line'>  app.use(app.router);
</span><span class='line'>});
</span><span class='line'> 
</span><span class='line'>app.configure('development', function(){
</span><span class='line'>  app.use(express.errorHandler({ dumpExceptions: true, showStack: true }));
</span><span class='line'>});
</span><span class='line'> 
</span><span class='line'>app.configure('production', function(){
</span><span class='line'>  app.use(express.errorHandler());
</span><span class='line'>});
</span><span class='line'> 
</span><span class='line'>// Routes
</span><span class='line'>//this is the route for /, or the root
</span><span class='line'>app.get('/',function(req,res) {
</span><span class='line'>  var data_collection = function(err,collection) {
</span><span class='line'>    //find all articles in the collection, and sort by article_date...
</span><span class='line'>    //pass it in as db_results
</span><span class='line'>    collection.find().sort({article_date: -1}).toArray(function(err,db_results) {
</span><span class='line'>      console.log(db_results);//just to show some output on the server, log the entire obj
</span><span class='line'>      res.render('index', {//render the index
</span><span class='line'>        blog_content: db_results //pass in the results to the page as a local blog_content
</span><span class='line'>      });
</span><span class='line'>    });
</span><span class='line'>  };
</span><span class='line'> 
</span><span class='line'>  db.open(function(err, p_client) {
</span><span class='line'>    db.collection('articles', data_collection);//this is the name of the collection...ie db.articles.find()
</span><span class='line'>  });
</span><span class='line'> 
</span><span class='line'>});
</span><span class='line'> 
</span><span class='line'>app.listen(9095);</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-//index.jade
</span><span class='line'>extends layout
</span><span class='line'>block content
</span><span class='line'>  -if(locals.blog_content) {
</span><span class='line'>    -for(var i=0; i&lt;blog_content.length; i++) {
</span><span class='line'>      h3=blog_content[i].article_title
</span><span class='line'>      p !{blog_content[i].article_body}
</span><span class='line'>    -}
</span><span class='line'>  -}</span></code></pre></td></tr></table></div></figure>


<p>At this point the page will loop through the blog articles in the database and display them all on the same page. To make it a little nicer, let&#8217;s do some creative modifications.Index.jade will take the length of the array, and if it&#8217;s 1, display that article with a blank &#8216;Comment Section&#8217;. If it&#8217;s more than 1, let&#8217;s loop through all of them, and make the title link to the article itself.For this to really do anything, we need the link to go to a distinct article, so App.js will have to be mofied to allow a direct link. In this case, We&#8217;re going to make it go to &#8216;/index/mongos_id_of_article&#8217;.You&#8217;ll notice a little work to get the id from the link. Node.js sees &#8216;/index/mongos_id_of_article&#8217; as &#8216;/index/:article_id&#8217;, which is translated to &#8216;request.paracms.article_id&#8217;. The last part of this is the coersion from this id to a BSON id for a Mongo lookup (BSON.ObjectId).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-//index.jade
</span><span class='line'>extends layout
</span><span class='line'>block content
</span><span class='line'>  -if(locals.blog_content) {
</span><span class='line'>    -if(blog_content.length == 1) {
</span><span class='line'>      h3=blog_content[0].article_title
</span><span class='line'>      p !{blog_content[0].article_body}
</span><span class='line'>      hr(width="100%")
</span><span class='line'>      | Comment Section
</span><span class='line'>    -} else {
</span><span class='line'>      -for(var i=0; i&lt;blog_content.length; i++) {
</span><span class='line'>        h3
</span><span class='line'>          a(href='/article/'+blog_content[i]._id)=blog_content[i].article_title
</span><span class='line'>        p !{blog_content[i].article_body}
</span><span class='line'>      -}
</span><span class='line'>    -}
</span><span class='line'>  -}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//this is the route for /article/somenumber .. somenumber is available in the request
</span><span class='line'>app.get('/article/:article_id',function(req,res) {
</span><span class='line'>  var data_collection = function(err,collection) {
</span><span class='line'>    var BSON = mongodb.BSONPure;//load the BSON object
</span><span class='line'>    var o_id = new BSON.ObjectID(req.params.article_id);//this is now a searchable
</span><span class='line'>                                                        //id for collection
</span><span class='line'>    collection.find({_id: o_id}).toArray(function(err,db_results) {
</span><span class='line'>      res.render('index', {//render the index
</span><span class='line'>        blog_content: db_results //pass the db_results to a local variable in index
</span><span class='line'>                                 //called blog_content
</span><span class='line'>      });
</span><span class='line'>    });
</span><span class='line'>  };
</span><span class='line'>  db.open(function(err, p_client) {
</span><span class='line'>    db.collection('articles', data_collection);//this is the name of the collection...ie db.articles.find()
</span><span class='line'>  });
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>If you run it at this point, you&#8217;ll be able to hit the index, see links to articles and go directly to them with a blank comment section. Let&#8217;s make that comment section. To prep for this, we&#8217;ll need a form to POST to /comment</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-//index.jade
</span><span class='line'>extends layout
</span><span class='line'>block content
</span><span class='line'>  -if(locals.blog_content) {
</span><span class='line'>    -if(blog_content.length == 1) {
</span><span class='line'>      h3=blog_content[0].article_title
</span><span class='line'>      p !{blog_content[0].article_body}
</span><span class='line'>      hr(width="100%")
</span><span class='line'>      | Comment Section
</span><span class='line'>      form(method='post',action='/comment')
</span><span class='line'>        label Name:
</span><span class='line'>          input(type='text',name='postername')
</span><span class='line'>        label Comment:
</span><span class='line'>          textarea(type='text',name='postercomment')
</span><span class='line'>        input(type='hidden',name='current_id',value=blog_content[0]._id)
</span><span class='line'>        input(type='submit',value='submit')
</span><span class='line'>    -} else {
</span><span class='line'>      -for(var i=0; i&lt;blog_content.length; i++) {
</span><span class='line'>        h3
</span><span class='line'>          a(href='/article/'+blog_content[i]._id)=blog_content[i].article_title
</span><span class='line'>        p !{blog_content[i].article_body}
</span><span class='line'>      -}
</span><span class='line'>    -}
</span><span class='line'>  -}</span></code></pre></td></tr></table></div></figure>


<p>If you run this now, you&#8217;ll get an error. That&#8217;s because we don&#8217;t have a route for a POST to /comment, so let&#8217;s set that up.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app.post('/comment',function(req,res) {                                                                         
</span><span class='line'>  var bodyarr = [];                                                                                             
</span><span class='line'>  req.on('data', function(chunk){                                                                               
</span><span class='line'>    bodyarr.push(chunk);                                                                                        
</span><span class='line'>  });                                                                                                           
</span><span class='line'>  req.on('end', function(){
</span><span class='line'>    /* This is hackish but is to only show proof of concept                                                     
</span><span class='line'>       This will split the bodyarr that we've created                                                           
</span><span class='line'>          ex: id=4&body=what%20up&something=somethingelse                                                       
</span><span class='line'>    */                                                                                                          
</span><span class='line'>    var values = bodyarr.join('').split('&');                                                                   
</span><span class='line'>    var BSON = mongodb.BSONPure;//this will load the mongo BSON                                                 
</span><span class='line'>    var article_id = new BSON.ObjectID(values[2].split('=')[1]);//this was the argument for ID                  
</span><span class='line'> 
</span><span class='line'>    //create a 'comment' object that contains the poster and comment                                            
</span><span class='line'>    var comment_object = {                                                                                      
</span><span class='line'>      'poster': values[].split('=')[1],
</span><span class='line'>      'comment': values[1].split('=')[1]
</span><span class='line'>    };                                                                                                          
</span><span class='line'>    var data_collection = function(err,collection) {                                                            
</span><span class='line'>      //call update on the collection, find by _id, and push the comment object onto it                         
</span><span class='line'>      collection.update({_id: article_id},{$push : { comments : comment_object }});
</span><span class='line'>      res.redirect('back');
</span><span class='line'>    };
</span><span class='line'>    db.open(function(err, p_client) {                                                                           
</span><span class='line'>      db.collection('articles', data_collection);//this is the name of the collection...ie db.articles.find()   
</span><span class='line'>    });
</span><span class='line'>  });
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>It got a little complicated in that snippet, so here&#8217;s a slight breakdown. The post takes the data as a stream (req.on) and pushes it to an array. On the end of the stream we&#8217;ll break up the values,and push it onto the mongo collection for that id (we know the id from the hidden form element). The push is an Object that&#8217;s a &#8216;poster&#8217; and a &#8216;comment&#8217;. When this is finished, we&#8217;ll redirect backwards. This is dandy, but you&#8217;ll notice we haven&#8217;t set up the view to display comments, only store. The newest code has the addition of a loop. If comments exists(if the collection even has a comment array), we will loop through it and display it. For handiness, you&#8217;ll also notice the addition of a link to &#8216;/&#8217;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-//index.jade 
</span><span class='line'>extends layout
</span><span class='line'>-//overwrite the content block with new data
</span><span class='line'>block content 
</span><span class='line'>  -if(locals.blog_content) {//make sure it has a blog_content (to be safe and not
</span><span class='line'>                            //cause an Express crash
</span><span class='line'>    -if(blog_content.length == 1) {//only 1 article, means they clicked on
</span><span class='line'>                                   //an article link to view it....
</span><span class='line'>                                   //so render it with the comment form data
</span><span class='line'>      h3=blog_content[0].article_title
</span><span class='line'>      p !{blog_content[0].article_body}
</span><span class='line'>      hr(width="100%")
</span><span class='line'>      | Comment Section
</span><span class='line'>      form(method='post',action='/comment')
</span><span class='line'>        label Name:
</span><span class='line'>          input(type='text',name='postername')
</span><span class='line'>        label Comment:
</span><span class='line'>          textarea(type='text',name='postercomment')
</span><span class='line'>        input(type='hidden',name='current_id',value=blog_content[0]._id)
</span><span class='line'>        input(type='submit',value='submit')
</span><span class='line'>      hr(width="100%")
</span><span class='line'>      -var comments = blog_content[0].comments;
</span><span class='line'>      -if(comments && comments != undefined) {
</span><span class='line'>        -for(var i=0; i&lt;comments.length;i++) {
</span><span class='line'>          h3=comments[i].poster
</span><span class='line'>          | !{comments[i].comment}
</span><span class='line'>        -}
</span><span class='line'>      -}
</span><span class='line'>      hr(width="100%")
</span><span class='line'>      a(href='/') Home
</span><span class='line'>    -} else {//more than one article, meaning they're at the 'blog root',
</span><span class='line'>             //looking at all the links
</span><span class='line'>      -for(var i=0; i&lt;blog_content.length; i++) {//loop through blog array
</span><span class='line'>        h3
</span><span class='line'>          a(href='/article/'+blog_content[i]._id)=blog_content[i].article_title
</span><span class='line'>        p !{blog_content[i].article_body}
</span><span class='line'>      -}
</span><span class='line'>    -}
</span><span class='line'>  -}</span></code></pre></td></tr></table></div></figure>


<p>This last snippet is a clean up of the comment post. Since it&#8217;s parsed as parameters, spaces are +&#8217;s. This could be fixed by modifying the way I handle the post as a stream, but for demonstrations sake, let&#8217;s just do a regex replace of /+/ to spaces.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app.post('/comment',function(req,res) {
</span><span class='line'>  var bodyarr = [];
</span><span class='line'>  req.on('data', function(chunk){
</span><span class='line'>    bodyarr.push(chunk);
</span><span class='line'>  });
</span><span class='line'>  req.on('end', function(){//the data has finished coming in
</span><span class='line'>    /* This is hackish but is to only show proof of concept
</span><span class='line'>       This will split the bodyarr that we've created
</span><span class='line'>          ex: id=4&body=what%20up&something=somethingelse
</span><span class='line'>    */
</span><span class='line'>    var values = bodyarr.join('').split('&');
</span><span class='line'>    var BSON = mongodb.BSONPure;//this will load the mongo BSON
</span><span class='line'>    var article_id = new BSON.ObjectID(values[2].split('=')[1]);//this was the argument for ID
</span><span class='line'> 
</span><span class='line'>    //create a 'comment' object that contains the poster and comment
</span><span class='line'>    var comment_object = {
</span><span class='line'>      'poster': values[].split('=')[1].replace(/+/g,' '),//had +'s for spaces, so replace them
</span><span class='line'>      'comment': values[1].split('=')[1].replace(/+/g,' ')
</span><span class='line'>    };
</span><span class='line'> 
</span><span class='line'>    var data_collection = function(err,collection) {
</span><span class='line'>      //call update on the collection, find by _id, and push the comment object onto it
</span><span class='line'>      collection.update({_id: article_id},{$push : { comments : comment_object }});
</span><span class='line'>      res.redirect('back');//send the user to the previous page
</span><span class='line'>    };
</span><span class='line'>    db.open(function(err, p_client) {
</span><span class='line'>      db.collection('articles', data_collection);//this is the name of the collection...ie db.articles.find()
</span><span class='line'>    });
</span><span class='line'>  });
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">myoung</span></span>

      








  


<time datetime="2012-04-25T00:00:00-05:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/mongodb/'>mongodb</a>, <a class='category' href='/blog/categories/node-dot-js/'>node.js</a>, <a class='category' href='/blog/categories/programming/'>programming</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/post/seriously-mysql/" title="Previous Post: Seriously MySQL?">&laquo; Seriously MySQL?</a>
      
      
        <a class="basic-alignment right articlenav" href="/post/i-made-beer/" title="Next Post: I Made Beer">I Made Beer &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/post/mirth-puppet-module">New Puppet Module - MirthConnect</a>
      </li>
    
      <li class="post">
        <a href="/post/continuous-deployment-using-puppet-and-pulp-pt-4-puppet-jenkins">Complete Continuous Deployment Using Puppet and Pulp - Part 4 - Puppet and Jenkins</a>
      </li>
    
      <li class="post">
        <a href="/post/continuous-deployment-using-puppet-and-pulp-pt-3-enter-puppet">Complete Continuous Deployment Using Puppet and Pulp - Part 3 - Enter Puppet</a>
      </li>
    
      <li class="post">
        <a href="/post/continuous-deployment-using-puppet-and-pulp-pt-2-the-app">Complete Continuous Deployment Using Puppet and Pulp - Part 2 - the Application</a>
      </li>
    
      <li class="post">
        <a href="/post/continuous-deployment-using-puppet-and-pulp-pt-1-the-machines">Complete Continuous Deployment Using Puppet and Pulp - Part 1 - the Machines</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'myoung34',
            count: 0,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/106595646200297464671?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Marcus Young -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'marcyoung';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://myoung34.github.io/post/creating-an-mvc-blog-with-node-js-and-mongodb/';
        var disqus_url = 'http://myoung34.github.io/post/creating-an-mvc-blog-with-node-js-and-mongodb/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>







</body>
</html>
